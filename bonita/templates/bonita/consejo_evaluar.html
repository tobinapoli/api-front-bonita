<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Evaluar Respuesta ONG</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    /* Para que el footer quede abajo */
    body {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    main {
      flex: 1;
    }
  </style>
</head>
<body class="bg-light">

<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
  <div class="container">
    <a class="navbar-brand" href="#">Consejo Directivo</a>
  </div>
</nav>

<main>
  <div class="container py-5" style="max-width:800px">
    <div class="card shadow">
      <div class="card-header bg-warning text-dark">
        <h4 class="mb-0">⚠️ Evaluar Respuesta de ONG</h4>
      </div>
      <div class="card-body">
        <div id="loading" class="text-center">
          <div class="spinner-border text-primary"></div>
          <p>Cargando respuesta pendiente...</p>
        </div>

        <div id="contenido" style="display:none;">
          <div class="alert alert-info">
              <h5>Observación Original:</h5>
              <p id="txtObservacion" class="mb-0 fst-italic"></p>
          </div>

          <div class="card mb-4 border-success">
              <div class="card-header bg-success text-white">Respuesta de la ONG</div>
              <div class="card-body">
                  <h5 class="card-title" id="txtRespuesta"></h5>
                  <p class="text-muted small mb-0">Fecha: <span id="txtFecha"></span></p>
              </div>
          </div>

          <hr>
          <h5 class="mb-3">Decisión del Consejo:</h5>
          <div class="d-flex gap-3">
              <button onclick="enviarDecision(false)" class="btn btn-danger flex-grow-1 p-3">
                  ❌ RECHAZAR
                  <br><small>La respuesta no es suficiente</small>
              </button>
              <button onclick="enviarDecision(true)" class="btn btn-success flex-grow-1 p-3">
                  ✅ APROBAR
                  <br><small>Cerrar observación</small>
              </button>
          </div>
          
          <input type="hidden" id="obsId">
        </div>

        <div id="errorMsg" class="alert alert-danger mt-3" style="display:none;"></div>
      </div>
    </div>
  </div>
</main>

<footer class="mt-4 bg-light border-top py-3">
  <div class="container text-center text-muted small">
    © 2025 ProjectPlanning · Organizaciones sociales en red
  </div>
</footer>

<script>
  const caseId = new URLSearchParams(location.search).get("case");

  function formatearFecha(fechaStr) {
    if (!fechaStr) return "-";
    try {
      const d = new Date(fechaStr);
      if (isNaN(d)) return fechaStr;
      return d.toLocaleDateString("es-AR", {
        day: "2-digit",
        month: "2-digit",
        year: "numeric"
      });
    } catch {
      return fechaStr;
    }
  }

  function mostrarError(msg) {
    const div = document.getElementById("errorMsg");
    div.textContent = msg || "Ocurrió un error al cargar la información.";
    div.style.display = "block";
    document.getElementById("loading").style.display = "none";
    document.getElementById("contenido").style.display = "none";
  }

  async function cargarDatos() {
    try {
      const res = await fetch(`/api/bonita/consejo/datos-evaluacion/?case=${encodeURIComponent(caseId)}`);
      if (!res.ok) throw new Error("Error cargando observaciones");
      
      const j = await res.json(); 
      const lista = j.respuestas || []; 
      
      if (lista.length > 0) {
          const obs = lista[0];
          document.getElementById("txtObservacion").innerText = obs.texto;
          document.getElementById("txtRespuesta").innerText = obs.respuesta;
          document.getElementById("txtFecha").innerText = formatearFecha(obs.fecha_respuesta);
          document.getElementById("obsId").value = obs.id;
          
          document.getElementById("loading").style.display = "none";
          document.getElementById("contenido").style.display = "block";
      } else {
          document.getElementById("loading").innerHTML = "<p>No se encontraron respuestas pendientes.</p>";
      }
      
    } catch (e) {
      mostrarError(e.message);
    }
  }

  async function enviarDecision(aprobada) {
    const obsId = document.getElementById("obsId").value;
    if (!obsId) return;
    
    const btnReject = document.querySelector('.btn-danger');
    const btnApprove = document.querySelector('.btn-success');
    btnReject.disabled = true;
    btnApprove.disabled = true;
    
    try {
        const res = await fetch("/api/bonita/consejo/evaluar/", { 
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({
                caseId: caseId,
                observacionId: parseInt(obsId),
                aprobada: aprobada
            })
        });

        const j = await res.json();
        
        if (j.ok) {
            document.getElementById("contenido").style.opacity = "0.5";
            
            const resNext = await fetch("/api/bonita/next-step/", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({ caseId: caseId })
            });
            
            const jNext = await resNext.json();
            
            if (jNext.ok && jNext.url) {
                const u = new URL(jNext.url, window.location.origin);
                if (jNext.rol) u.searchParams.set("rol", jNext.rol);
                u.searchParams.set("case", caseId);
                
                window.location.href = u.toString();
            } else {
                window.location.href = "/bonita/consejo/?case=" + caseId; 
            }

        } else {
            throw new Error(j.error || "Error al procesar");
        }
    } catch (e) {
        alert(e.message);
        btnReject.disabled = false;
        btnApprove.disabled = false;
        document.getElementById("contenido").style.opacity = "1";
    }
  }

  cargarDatos();
</script>

</body>
</html>
