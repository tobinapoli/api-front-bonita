<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Nuevo Proyecto (Bonita)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container">
      <a class="navbar-brand" href="/bonita/login/">ProjectPlanning</a>
    </div>
  </nav>

  <div class="container py-4">
    <div class="card shadow-sm">
      <div class="card-header bg-primary text-white">
        <h3 class="mb-0">Nuevo Proyecto</h3>
      </div>
      <div class="card-body">
        <form id="proyectoForm">
          <input type="hidden" name="case" value="{{ request.GET.case }}">
          <div class="mb-3">
            <label class="form-label fw-bold">Nombre del proyecto</label>
            <input type="text" name="nombre" class="form-control" required>
          </div>

          <div class="mb-3">
            <label class="form-label fw-bold">Descripci贸n</label>
            <textarea name="descripcion" class="form-control" rows="3" placeholder="Breve descripci贸n"></textarea>
          </div>

          <!-- PLAN DE TRABAJO CON ETAPAS DINMICAS -->
          <fieldset class="border p-3 mb-4 rounded">
            <legend class="float-none w-auto px-2 fw-semibold text-primary">Plan de trabajo</legend>

            <!-- Contenedor de todas las etapas -->
            <div id="etapasContainer" class="d-flex flex-column gap-3">

              <!-- Primera etapa (index 0) -->
              <div class="etapa-row border rounded p-3" data-index="0">
                <div class="row g-3 align-items-end">
                  <div class="col-md-6">
                    <label class="form-label">Nombre de etapa</label>
                    <input type="text"
                           class="form-control etapa-nombre"
                           placeholder="Nombre de la etapa"
                           required>
                  </div>
                  <div class="col-md-3">
                    <label class="form-label">Inicio</label>
                    <input type="date"
                           class="form-control etapa-inicio"
                           required>
                  </div>
                  <div class="col-md-3">
                    <label class="form-label">Fin</label>
                    <input type="date"
                           class="form-control etapa-fin"
                           required>
                  </div>
                </div>
                <div class="mt-2 text-end">
                  <button type="button"
                          class="btn btn-sm btn-outline-danger btn-remove-etapa"
                          disabled>
                    Quitar
                  </button>
                </div>
              </div>

            </div>

            <div class="mt-3">
              <button type="button" id="btnAddEtapa" class="btn btn-outline-primary btn-sm">
                Agregar etapa
              </button>
              <small class="text-muted ms-2">(m谩ximo 5 etapas)</small>
            </div>
          </fieldset>

          <fieldset class="border p-3 mb-4 rounded">
            <legend class="float-none w-auto px-2 fw-semibold text-primary">Plan econ贸mico</legend>
            <div class="row g-3">
              <div class="col-md-3">
                <label class="form-label">Moneda base</label>
                <select name="planEconomico.monedaBase" class="form-select" required>
                  <option value="">-- Seleccionar --</option>
                  <option value="ARS">ARS (Peso Argentino)</option>
                  <option value="USD">USD (D贸lar Estadounidense)</option>
                  <option value="EUR">EUR (Euro)</option>
                  <option value="BRL">BRL (Real Brasile帽o)</option>
                  <option value="UYU">UYU (Peso Uruguayo)</option>
                  <option value="CLP">CLP (Peso Chileno)</option>
                </select>
              </div>
              <div class="col-md-5">
                <label class="form-label">Rubro</label>
                <select name="planEconomico.presupuestoPorRubro[0].rubro" class="form-select" required>
                  <option value="">-- Seleccionar --</option>
                  <option value="Desarrollo">Desarrollo</option>
                  <option value="Testing">Testing</option>
                  <option value="Gesti贸n">Gesti贸n</option>
                  <option value="Infraestructura">Infraestructura</option>
                  <option value="Dise帽o">Dise帽o</option>
                  <option value="Documentaci贸n">Documentaci贸n</option>
                  <option value="Capacitaci贸n">Capacitaci贸n</option>
                  <option value="Soporte">Soporte</option>
                  <option value="Otro">Otro</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label">Monto</label>
                <input type="number" step="0.01" min="0" name="planEconomico.presupuestoPorRubro[0].monto" class="form-control" required>
              </div>
            </div>
          </fieldset>

          <div class="text-end">
            <button type="submit" class="btn btn-primary px-4">Crear proyecto</button>
          </div>
        </form>

        <div id="resultado" class="mt-4"></div>
      </div>
    </div>
  </div>

  <script>
    // Constantes de validaci贸n
    const VALID_CURRENCIES = ["ARS", "USD", "EUR", "BRL", "UYU", "CLP"];
    const VALID_RUBROS = [
      "Desarrollo",
      "Testing",
      "Gesti贸n",
      "Infraestructura",
      "Dise帽o",
      "Documentaci贸n",
      "Capacitaci贸n",
      "Soporte",
      "Otro"
    ];
    const MAX_ETAPAS = 5;

    function qp(name){ return new URLSearchParams(location.search).get(name); }

    //  Solo ONG originante puede ver esta pantalla
    (function () {
      const rol = qp("rol");
      if (rol && rol !== "ong_originante") {
        document.body.innerHTML =
          '<div class="container py-5"><div class="alert alert-warning">No ten茅s permiso para crear proyectos.</div></div>';
        throw new Error("No autorizado");
      }
    })();

    // --------- ETAPAS DINMICAS Y FECHAS ---------

    function createEtapaRow(index) {
      const div = document.createElement("div");
      div.className = "etapa-row border rounded p-3";
      div.dataset.index = String(index);
      div.innerHTML = `
        <div class="row g-3 align-items-end">
          <div class="col-md-6">
            <label class="form-label">Nombre de etapa</label>
            <input type="text"
                   class="form-control etapa-nombre"
                   placeholder="Nombre de la etapa"
                   required>
          </div>
          <div class="col-md-3">
            <label class="form-label">Inicio</label>
            <input type="date"
                   class="form-control etapa-inicio"
                   required>
          </div>
          <div class="col-md-3">
            <label class="form-label">Fin</label>
            <input type="date"
                   class="form-control etapa-fin"
                   required>
          </div>
        </div>
        <div class="mt-2 text-end">
          <button type="button"
                  class="btn btn-sm btn-outline-danger btn-remove-etapa">
            Quitar
          </button>
        </div>
      `;
      return div;
    }

    function renumerarEtapas() {
      const filas = document.querySelectorAll(".etapa-row");
      filas.forEach((row, idx) => {
        row.dataset.index = String(idx);
        const btnRemove = row.querySelector(".btn-remove-etapa");
        btnRemove.disabled = (filas.length === 1 && idx === 0);
      });
    }

    // Recalcula los min de TODAS las etapas seg煤n hoy y las fechas de fin anteriores
    function recalcularMinimos() {
      const rows = Array.from(document.querySelectorAll(".etapa-row"));

      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const todayISO = today.toISOString().split("T")[0];

      let prevEnd = todayISO;  // por defecto hoy

      rows.forEach(row => {
        const ini = row.querySelector(".etapa-inicio");
        const fin = row.querySelector(".etapa-fin");

        ini.min = prevEnd;
        fin.min = prevEnd;

        if (fin.value) {
          prevEnd = fin.value;
        }
      });
    }

    document.addEventListener("DOMContentLoaded", () => {
      const container = document.getElementById("etapasContainer");
      const btnAdd = document.getElementById("btnAddEtapa");

      // Inicial: min = hoy para la primera etapa
      recalcularMinimos();

      // Cuando cambia cualquier fecha de fin, recalculamos los min de todas
      container.addEventListener("change", (e) => {
        const target = e.target;
        if (target.classList.contains("etapa-fin")) {
          recalcularMinimos();
        }
      });

      btnAdd.addEventListener("click", () => {
        const actuales = container.querySelectorAll(".etapa-row").length;
        if (actuales >= MAX_ETAPAS) {
          alert(`S贸lo pod茅s cargar hasta ${MAX_ETAPAS} etapas.`);
          return;
        }
        const row = createEtapaRow(actuales);
        container.appendChild(row);

        renumerarEtapas();
        recalcularMinimos();   // importante: rearmar min despu茅s de agregar
      });

      container.addEventListener("click", (e) => {
        const target = e.target;
        if (target.classList.contains("btn-remove-etapa")) {
          const row = target.closest(".etapa-row");
          if (!row) return;
          if (container.querySelectorAll(".etapa-row").length === 1) return;
          row.remove();
          renumerarEtapas();
          recalcularMinimos();  // importante: rearmar min despu茅s de borrar
        }
      });

      renumerarEtapas();
    });

    // --------- VALIDACIN EN EL CLIENTE ---------

    function validateClientForm(form) {
      const errors = [];
      const nombre = (form["nombre"].value || "").trim();
      if (!nombre) errors.push({ path: "nombre", msg: "Requerido." });

      const today = new Date();
      today.setHours(0, 0, 0, 0);

      // Validaci贸n de todas las etapas
      const etapaRows = document.querySelectorAll(".etapa-row");
      if (etapaRows.length === 0) {
        errors.push({ path: "planTrabajo.etapas", msg: "Debe haber al menos una etapa." });
      } else if (etapaRows.length > MAX_ETAPAS) {
        errors.push({ path: "planTrabajo.etapas", msg: `No puede haber m谩s de ${MAX_ETAPAS} etapas.` });
      } else {
        let prevEnd = null;

        etapaRows.forEach((row, idx) => {
          const etapaNombre = (row.querySelector(".etapa-nombre").value || "").trim();
          const etapaIni = row.querySelector(".etapa-inicio").value;
          const etapaFin = row.querySelector(".etapa-fin").value;

          if (!etapaNombre) {
            errors.push({ path: `planTrabajo.etapas[${idx}].nombre`, msg: "Requerido." });
          }

          let dIni = null;
          let dFin = null;

          if (!etapaIni) {
            errors.push({ path: `planTrabajo.etapas[${idx}].fechaInicioPrevista`, msg: "Requerido." });
          } else {
            dIni = new Date(etapaIni + "T00:00:00");
            if (dIni < today) {
              errors.push({ path: `planTrabajo.etapas[${idx}].fechaInicioPrevista`, msg: "No puede ser anterior a hoy." });
            }
            if (prevEnd && dIni < prevEnd) {
              errors.push({
                path: `planTrabajo.etapas[${idx}].fechaInicioPrevista`,
                msg: "Debe ser mayor o igual a la fecha de fin de la etapa anterior."
              });
            }
          }

          if (!etapaFin) {
            errors.push({ path: `planTrabajo.etapas[${idx}].fechaFinPrevista`, msg: "Requerido." });
          } else {
            dFin = new Date(etapaFin + "T00:00:00");
            if (dFin < today) {
              errors.push({ path: `planTrabajo.etapas[${idx}].fechaFinPrevista`, msg: "No puede ser anterior a hoy." });
            }
            if (dIni && dFin < dIni) {
              errors.push({
                path: `planTrabajo.etapas[${idx}].fechaFinPrevista`,
                msg: "Debe ser mayor o igual a la fecha de inicio de la etapa."
              });
            }
          }

          if (dFin) {
            prevEnd = dFin;
          }
        });
      }

      // Plan econ贸mico
      const moneda = form["planEconomico.monedaBase"].value;
      if (!moneda) {
        errors.push({ path: "planEconomico.monedaBase", msg: "Requerido." });
      } else if (!VALID_CURRENCIES.includes(moneda)) {
        errors.push({ path: "planEconomico.monedaBase", msg: `Debe ser uno de: ${VALID_CURRENCIES.join(", ")}` });
      }

      const rubro = form["planEconomico.presupuestoPorRubro[0].rubro"].value;
      if (!rubro) {
        errors.push({ path: "planEconomico.presupuestoPorRubro[0].rubro", msg: "Requerido." });
      } else if (!VALID_RUBROS.includes(rubro)) {
        errors.push({ path: "planEconomico.presupuestoPorRubro[0].rubro", msg: `Debe ser uno de: ${VALID_RUBROS.join(", ")}` });
      }

      const montoStr = form["planEconomico.presupuestoPorRubro[0].monto"].value;
      if (!montoStr) {
        errors.push({ path: "planEconomico.presupuestoPorRubro[0].monto", msg: "Requerido." });
      } else {
        const monto = parseFloat(montoStr);
        if (isNaN(monto)) {
          errors.push({ path: "planEconomico.presupuestoPorRubro[0].monto", msg: "Debe ser un n煤mero." });
        } else if (monto < 0) {
          errors.push({ path: "planEconomico.presupuestoPorRubro[0].monto", msg: "No puede ser negativo." });
        }
      }

      return errors;
    }

    function displayErrors(errors) {
      const html = `
        <div class="alert alert-danger mt-3">
          <strong>Errores de validaci贸n:</strong>
          <ul class="mb-0 mt-2">
            ${errors.map(e => `<li><code>${e.path}</code>: ${e.msg}</li>`).join("")}
          </ul>
        </div>
      `;
      document.getElementById("resultado").innerHTML = html;
    }

    // --------- SUBMIT DEL FORM ---------

    document.getElementById("proyectoForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const form = e.target;

      const clientErrors = validateClientForm(form);
      if (clientErrors.length > 0) {
        displayErrors(clientErrors);
        return;
      }

      // Construimos el array de etapas para el JSON
      const etapasPayload = [];
      document.querySelectorAll(".etapa-row").forEach(row => {
        etapasPayload.push({
          nombre: row.querySelector(".etapa-nombre").value,
          fechaInicioPrevista: row.querySelector(".etapa-inicio").value,
          fechaFinPrevista: row.querySelector(".etapa-fin").value,
        });
      });

      const data = {
        caseId: qp("case"),
        nombre: form["nombre"].value,
        descripcion: form["descripcion"].value,
        planTrabajo: {
          etapas: etapasPayload
        },
        planEconomico: {
          monedaBase: form["planEconomico.monedaBase"].value,
          presupuestoPorRubro: [{
            rubro: form["planEconomico.presupuestoPorRubro[0].rubro"].value,
            monto: parseFloat(form["planEconomico.presupuestoPorRubro[0].monto"].value),
          }]
        }
      };

      const res = await fetch("/api/bonita/iniciar/", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(data)
      });
      const json = await res.json();

      if (!res.ok || (json.errors && json.errors.length > 0)) {
        const errors = json.errors || [{ path: "general", msg: json.error || "Error desconocido" }];
        displayErrors(errors);
      } else if (json.ok && json.caseId && json.proyectoId) {
        const rol = qp("rol") || "";
        const url =
          `/bonita/pedido/?case=${encodeURIComponent(json.caseId)}&proyecto=${encodeURIComponent(json.proyectoId)}&rol=${encodeURIComponent(rol)}`;
        location.href = url;
      } else {
        document.getElementById("resultado").innerHTML =
          `<pre class="bg-light border p-3 mt-3">${JSON.stringify(json, null, 2)}</pre>`;
      }
    });
  </script>
</body>
</html>
