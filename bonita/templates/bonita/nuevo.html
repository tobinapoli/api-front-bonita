<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Nuevo Proyecto (Bonita)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container">
      <a class="navbar-brand" href="/bonita/login/">ProjectPlanning</a>
      <div class="ms-auto">
        <a class="btn btn-outline-light btn-sm" href="/bonita/revisar/?case={{ request.GET.case|default_if_none:'' }}">Revisar pedidos</a>
      </div>
    </div>
  </nav>

  <div class="container py-4">
    <div class="card shadow-sm">
      <div class="card-header bg-primary text-white">
        <h3 class="mb-0">Nuevo Proyecto</h3>
      </div>
      <div class="card-body">
        <form id="proyectoForm">
          <input type="hidden" name="case" value="{{ request.GET.case }}">
          <div class="mb-3">
            <label class="form-label fw-bold">Nombre del proyecto</label>
            <input type="text" name="nombre" class="form-control" required>
          </div>

          <div class="mb-3">
            <label class="form-label fw-bold">Descripci贸n</label>
            <textarea name="descripcion" class="form-control" rows="3" placeholder="Breve descripci贸n"></textarea>
          </div>

          <fieldset class="border p-3 mb-4 rounded">
            <legend class="float-none w-auto px-2 fw-semibold text-primary">Metadata del proyecto</legend>
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Inicio previsto</label>
                <input type="date" id="metaIniInput" name="metadata.fechaInicioPrevista" class="form-control" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">Fin previsto</label>
                <input type="date" id="metaFinInput" name="metadata.fechaFinPrevista" class="form-control" required>
              </div>
            </div>
          </fieldset>

          <fieldset class="border p-3 mb-4 rounded">
            <legend class="float-none w-auto px-2 fw-semibold text-primary">Plan de trabajo (demo)</legend>
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Nombre de etapa</label>
                <input type="text" name="planTrabajo.etapas[0].nombre" class="form-control" required>
              </div>
              <div class="col-md-3">
                <label class="form-label">Inicio</label>
                <input type="date" id="etapaIniInput" name="planTrabajo.etapas[0].fechaInicioPrevista" class="form-control" required>
              </div>
              <div class="col-md-3">
                <label class="form-label">Fin</label>
                <input type="date" id="etapaFinInput" name="planTrabajo.etapas[0].fechaFinPrevista" class="form-control" required>
              </div>
            </div>
          </fieldset>

          <fieldset class="border p-3 mb-4 rounded">
            <legend class="float-none w-auto px-2 fw-semibold text-primary">Plan econ贸mico</legend>
            <div class="row g-3">
              <div class="col-md-3">
                <label class="form-label">Moneda base</label>
                <select name="planEconomico.monedaBase" class="form-select" required>
                  <option value="">-- Seleccionar --</option>
                  <option value="ARS">ARS (Peso Argentino)</option>
                  <option value="USD">USD (D贸lar Estadounidense)</option>
                  <option value="EUR">EUR (Euro)</option>
                  <option value="BRL">BRL (Real Brasile帽o)</option>
                  <option value="UYU">UYU (Peso Uruguayo)</option>
                  <option value="CLP">CLP (Peso Chileno)</option>
                </select>
              </div>
              <div class="col-md-5">
                <label class="form-label">Rubro</label>
                <select name="planEconomico.presupuestoPorRubro[0].rubro" class="form-select" required>
                  <option value="">-- Seleccionar --</option>
                  <option value="Desarrollo">Desarrollo</option>
                  <option value="Testing">Testing</option>
                  <option value="Gesti贸n">Gesti贸n</option>
                  <option value="Infraestructura">Infraestructura</option>
                  <option value="Dise帽o">Dise帽o</option>
                  <option value="Documentaci贸n">Documentaci贸n</option>
                  <option value="Capacitaci贸n">Capacitaci贸n</option>
                  <option value="Soporte">Soporte</option>
                  <option value="Otro">Otro</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label">Monto</label>
                <input type="number" step="0.01" min="0" name="planEconomico.presupuestoPorRubro[0].monto" class="form-control" required>
              </div>
            </div>
          </fieldset>

          <div class="text-end">
            <button type="submit" class="btn btn-primary px-4">Crear proyecto</button>
          </div>
        </form>

        <div id="resultado" class="mt-4"></div>
      </div>
    </div>
  </div>

  <script>
    const VALID_CURRENCIES = ["ARS", "USD", "EUR", "BRL", "UYU", "CLP"];
    const VALID_RUBROS = ["Desarrollo", "Testing", "Gesti贸n", "Infraestructura", "Dise帽o", "Documentaci贸n", "Capacitaci贸n", "Soporte", "Otro"];

    function qp(name){ return new URLSearchParams(location.search).get(name); }

    function formatDateISO(date) {
      return date.toISOString().split('T')[0];
    }

    function initializeDateRestrictions() {
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const todayISO = formatDateISO(today);

      const metaIniInput = document.getElementById("metaIniInput");
      const metaFinInput = document.getElementById("metaFinInput");
      const etapaIniInput = document.getElementById("etapaIniInput");
      const etapaFinInput = document.getElementById("etapaFinInput");

      // Metadata: inicio m铆nimo = hoy
      metaIniInput.min = todayISO;

      // Metadata: fin m铆nimo = hoy
      metaFinInput.min = todayISO;

      // Cuando cambia metaIni, actualizar restricciones
      metaIniInput.addEventListener("change", () => {
        const metaIniVal = metaIniInput.value;
        if (metaIniVal) {
          // Fin debe ser >= inicio
          metaFinInput.min = metaIniVal;
          // Etapa inicio debe ser >= metaInicio
          etapaIniInput.min = metaIniVal;
        }
      });

      // Cuando cambia metaFin, actualizar restricciones
      metaFinInput.addEventListener("change", () => {
        const metaFinVal = metaFinInput.value;
        if (metaFinVal) {
          // Etapa fin debe ser <= metaFin
          etapaFinInput.max = metaFinVal;
        }
      });

      // Cuando cambia etapaIni, actualizar restricciones
      etapaIniInput.addEventListener("change", () => {
        const etapaIniVal = etapaIniInput.value;
        if (etapaIniVal) {
          // Fin de etapa debe ser >= inicio de etapa
          etapaFinInput.min = etapaIniVal;
        }
      });

      // Cuando cambia metaIni nuevamente, limitar etapaIni
      metaIniInput.addEventListener("change", () => {
        const metaIniVal = metaIniInput.value;
        if (metaIniVal) {
          etapaIniInput.min = metaIniVal;
          // Resetear etapaIni si est谩 fuera del rango
          if (etapaIniInput.value && etapaIniInput.value < metaIniVal) {
            etapaIniInput.value = "";
            etapaFinInput.value = "";
          }
        }
      });

      // Cuando cambia metaFin nuevamente, limitar etapaFin
      metaFinInput.addEventListener("change", () => {
        const metaFinVal = metaFinInput.value;
        if (metaFinVal) {
          etapaFinInput.max = metaFinVal;
          // Resetear etapaFin si est谩 fuera del rango
          if (etapaFinInput.value && etapaFinInput.value > metaFinVal) {
            etapaFinInput.value = "";
          }
        }
      });
    }

    function validateClientForm(form) {
      const errors = [];

      // Nombre
      const nombre = (form["nombre"].value || "").trim();
      if (!nombre) errors.push({ path: "nombre", msg: "Requerido." });

      // Fechas de metadata
      const metaIni = form["metadata.fechaInicioPrevista"].value;
      const metaFin = form["metadata.fechaFinPrevista"].value;
      const today = new Date();
      today.setHours(0, 0, 0, 0);

      if (!metaIni) {
        errors.push({ path: "metadata.fechaInicioPrevista", msg: "Requerido." });
      } else {
        const d = new Date(metaIni + "T00:00:00");
        if (d < today) {
          errors.push({ path: "metadata.fechaInicioPrevista", msg: "No puede ser anterior a hoy." });
        }
      }

      if (!metaFin) {
        errors.push({ path: "metadata.fechaFinPrevista", msg: "Requerido." });
      } else {
        const d = new Date(metaFin + "T00:00:00");
        if (d < today) {
          errors.push({ path: "metadata.fechaFinPrevista", msg: "No puede ser anterior a hoy." });
        }
      }

      // Validar fin >= inicio
      if (metaIni && metaFin) {
        const dIni = new Date(metaIni + "T00:00:00");
        const dFin = new Date(metaFin + "T00:00:00");
        if (dFin < dIni) {
          errors.push({ path: "metadata.fechaFinPrevista", msg: "Debe ser >= fechaInicioPrevista." });
        }
      }

      // Etapa
      const etapaNombre = (form["planTrabajo.etapas[0].nombre"].value || "").trim();
      if (!etapaNombre) {
        errors.push({ path: "planTrabajo.etapas[0].nombre", msg: "Requerido." });
      }

      const etapaIni = form["planTrabajo.etapas[0].fechaInicioPrevista"].value;
      const etapaFin = form["planTrabajo.etapas[0].fechaFinPrevista"].value;

      if (!etapaIni) {
        errors.push({ path: "planTrabajo.etapas[0].fechaInicioPrevista", msg: "Requerido." });
      } else {
        const d = new Date(etapaIni + "T00:00:00");
        if (d < today) {
          errors.push({ path: "planTrabajo.etapas[0].fechaInicioPrevista", msg: "No puede ser anterior a hoy." });
        }
        if (metaIni) {
          const dMeta = new Date(metaIni + "T00:00:00");
          if (d < dMeta) {
            errors.push({ path: "planTrabajo.etapas[0].fechaInicioPrevista", msg: "No puede ser anterior al inicio del proyecto." });
          }
        }
      }

      if (!etapaFin) {
        errors.push({ path: "planTrabajo.etapas[0].fechaFinPrevista", msg: "Requerido." });
      } else {
        const d = new Date(etapaFin + "T00:00:00");
        if (d < today) {
          errors.push({ path: "planTrabajo.etapas[0].fechaFinPrevista", msg: "No puede ser anterior a hoy." });
        }
        if (metaFin) {
          const dMeta = new Date(metaFin + "T00:00:00");
          if (d > dMeta) {
            errors.push({ path: "planTrabajo.etapas[0].fechaFinPrevista", msg: "No puede superar el fin del proyecto." });
          }
        }
      }

      // Validar fin >= inicio en etapa
      if (etapaIni && etapaFin) {
        const dIni = new Date(etapaIni + "T00:00:00");
        const dFin = new Date(etapaFin + "T00:00:00");
        if (dFin < dIni) {
          errors.push({ path: "planTrabajo.etapas[0].fechaFinPrevista", msg: "Debe ser >= fechaInicioPrevista." });
        }
      }

      // Moneda
      const moneda = form["planEconomico.monedaBase"].value;
      if (!moneda) {
        errors.push({ path: "planEconomico.monedaBase", msg: "Requerido." });
      } else if (!VALID_CURRENCIES.includes(moneda)) {
        errors.push({ path: "planEconomico.monedaBase", msg: `Debe ser uno de: ${VALID_CURRENCIES.join(", ")}` });
      }

      // Rubro
      const rubro = form["planEconomico.presupuestoPorRubro[0].rubro"].value;
      if (!rubro) {
        errors.push({ path: "planEconomico.presupuestoPorRubro[0].rubro", msg: "Requerido." });
      } else if (!VALID_RUBROS.includes(rubro)) {
        errors.push({ path: "planEconomico.presupuestoPorRubro[0].rubro", msg: `Debe ser uno de: ${VALID_RUBROS.join(", ")}` });
      }

      // Monto
      const montoStr = form["planEconomico.presupuestoPorRubro[0].monto"].value;
      if (!montoStr) {
        errors.push({ path: "planEconomico.presupuestoPorRubro[0].monto", msg: "Requerido." });
      } else {
        const monto = parseFloat(montoStr);
        if (isNaN(monto)) {
          errors.push({ path: "planEconomico.presupuestoPorRubro[0].monto", msg: "Debe ser un n煤mero." });
        } else if (monto < 0) {
          errors.push({ path: "planEconomico.presupuestoPorRubro[0].monto", msg: "No puede ser negativo." });
        }
      }

      return errors;
    }

    function displayErrors(errors) {
      const html = `
        <div class="alert alert-danger mt-3">
          <strong>Errores de validaci贸n:</strong>
          <ul class="mb-0 mt-2">
            ${errors.map(e => `<li><code>${e.path}</code>: ${e.msg}</li>`).join("")}
          </ul>
        </div>
      `;
      document.getElementById("resultado").innerHTML = html;
    }

    document.getElementById("proyectoForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const form = e.target;

      // Validar en cliente
      const clientErrors = validateClientForm(form);
      if (clientErrors.length > 0) {
        displayErrors(clientErrors);
        return;
      }

      const data = {
        caseId: qp("case"),
        nombre: form["nombre"].value,
        descripcion: form["descripcion"].value,
        metadata: {
          fechaInicioPrevista: form["metadata.fechaInicioPrevista"].value,
          fechaFinPrevista: form["metadata.fechaFinPrevista"].value,
        },
        planTrabajo: {
          etapas: [{
            nombre: form["planTrabajo.etapas[0].nombre"].value,
            fechaInicioPrevista: form["planTrabajo.etapas[0].fechaInicioPrevista"].value,
            fechaFinPrevista: form["planTrabajo.etapas[0].fechaFinPrevista"].value,
          }]
        },
        planEconomico: {
          monedaBase: form["planEconomico.monedaBase"].value,
          presupuestoPorRubro: [{
            rubro: form["planEconomico.presupuestoPorRubro[0].rubro"].value,
            monto: parseFloat(form["planEconomico.presupuestoPorRubro[0].monto"].value),
          }]
        }
      };

      const res = await fetch("/api/bonita/iniciar/", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(data)
      });
      const json = await res.json();
      
      // Si hay errores, mostrarlos
      if (!res.ok || (json.errors && json.errors.length > 0)) {
        const errors = json.errors || [{ path: "general", msg: json.error || "Error desconocido" }];
        displayErrors(errors);
      } else if (json.ok && json.caseId && json.proyectoId) {
        //  Redirigir autom谩ticamente a la pantalla de registrar pedido
        const url = `/bonita/pedido/?case=${encodeURIComponent(json.caseId)}&proyecto=${encodeURIComponent(json.proyectoId)}`;
        location.href = url;
      } else {
        // Fallback: mostrar respuesta si por alg煤n motivo no vino proyectoId
        document.getElementById("resultado").innerHTML =
          `<pre class="bg-light border p-3 mt-3">${JSON.stringify(json, null, 2)}</pre>`;
      }
    });

    // Inicializar restricciones de fechas cuando carga la p谩gina
    document.addEventListener("DOMContentLoaded", initializeDateRestrictions);
  </script>
</body>
</html>
  