<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Evaluar propuestas | ProjectPlanning</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body {
      background: #f5f7fa;
      font-family: "Segoe UI", Roboto, Arial, sans-serif;
    }

    .page-wrapper {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    main {
      flex: 1;
      display: flex;
      justify-content: center;
      padding: 2rem 1rem;
    }

    footer {
      background: rgba(0, 0, 0, 0.04);
      padding: 1rem;
      text-align: center;
      font-size: 0.9rem;
      color: #6b7280;
    }
  </style>
</head>
<body>

<div class="page-wrapper">

  <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container">
      <a class="navbar-brand" href="/bonita/login/">ProjectPlanning</a>
    </div>
  </nav>

  <main>
    <div class="container" style="max-width:960px">
      <div class="card shadow-sm w-100">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
          <h4 class="mb-0">Evaluar propuestas</h4>
        </div>

        <div class="card-body">
          <div class="alert alert-info">
            Acá como ONG originante puede evaluar los compromisos recibidos para tu pedido.
            Si todavía no hay compromisos, podés usar <strong>“Volver a evaluar”</strong>
            para que el flujo vuelva a esta tarea cuando existan nuevas propuestas.
          </div>

          <div id="panelCompromisos" class="mb-3"></div>

          <div class="d-flex justify-content-between mt-4">
            <a href="/bonita/login/" class="btn btn-outline-secondary btn-sm">
              Volver al inicio
            </a>

            <div class="d-flex gap-2">
              <button id="btnVolverEvaluar" class="btn btn-outline-primary btn-sm" type="button">
                Volver a evaluar
              </button>

              <button id="btnConfirmar" class="btn btn-success btn-sm" type="button">
                Aceptar
              </button>

              <button id="btnConfirmarEjecutar" class="btn btn-warning btn-sm" type="button">
                Aceptar y pasar a ejecución
              </button>
            </div>
          </div>

          <div id="msg" class="mt-3"></div>
        </div>
      </div>
    </div>
  </main>

  <footer>
    © 2025 ProjectPlanning · Organizaciones sociales en red
  </footer>

</div>

<script>
  function qp(n) {
    return new URLSearchParams(location.search).get(n);
  }

  // mismo formato de fecha que en "Revisar pedidos"
  function formatearFecha(fechaIso) {
    if (!fechaIso) return "";
    const d = new Date(fechaIso);
    if (isNaN(d.getTime())) return fechaIso;
    const mesesCortos = ["ene", "feb", "mar", "abr", "may", "jun", "jul", "ago", "sep", "oct", "nov", "dic"];
    const dia = d.getDate();
    const mes = mesesCortos[d.getMonth()];
    const anio = d.getFullYear();
    return `${dia} de ${mes}, ${anio}`;
  }

  const panel = document.getElementById("panelCompromisos");
  const msg   = document.getElementById("msg");
  const btnVolver   = document.getElementById("btnVolverEvaluar");
  const btnConfirm  = document.getElementById("btnConfirmar");
  const btnConfirmEj = document.getElementById("btnConfirmarEjecutar");

  function setMsg(html) {
    msg.innerHTML = html || "";
  }

  // Habilita/deshabilita botones según haya o no compromiso seleccionado
  function actualizarEstadoBotones() {
    const seleccionado = !!document.querySelector('input[name="compromisoRadio"]:checked');
    btnVolver.disabled    = false;
    btnConfirm.disabled   = !seleccionado;
    btnConfirmEj.disabled = !seleccionado;
  }

  // Estado inicial: sin selección, sólo "volver a evaluar" habilitado
  actualizarEstadoBotones();

  function renderCompromisos(lista) {
    if (!lista || lista.length === 0) {
      panel.innerHTML = `
        <div class="alert alert-secondary">
          No hay compromisos para este pedido todavía.
          Podés usar el botón <strong>"Volver a evaluar"</strong> para que el flujo vuelva más adelante.
        </div>`;
      actualizarEstadoBotones();
      return;
    }

    const html = lista.map(c => {
      const detalle = c.detalle || "";
      const monto   = (c.monto !== null && c.monto !== undefined)
        ? `Monto ofrecido: <strong>${c.monto}</strong><br>`
        : "";
      const fechaFmt = c.fecha ? formatearFecha(c.fecha) : "";
      const fecha   = fechaFmt ? `Fecha: <strong>${fechaFmt}</strong><br>` : "";
      const estado  = c.estado ? `Estado: <strong>${c.estado}</strong>` : "";

      return `
        <div class="border rounded p-3 mb-2 bg-white">
          <div class="form-check">
            <input class="form-check-input me-2"
                   type="radio"
                   name="compromisoRadio"
                   id="comp_${c.id}"
                   value="${c.id}">
            <label class="form-check-label" for="comp_${c.id}">
              <strong>Compromiso recibido</strong>
              <div class="small text-muted mt-1">
                ${detalle ? `${detalle}<br>` : ""}
                ${monto}${fecha}${estado}
              </div>
            </label>
          </div>
        </div>
      `;
    }).join("");

    panel.innerHTML = `
      <h5 class="mb-3">Propuestas recibidas</h5>
      ${html}
    `;

    // Escuchar cambios en los radios para habilitar/deshabilitar botones
    const radios = document.querySelectorAll('input[name="compromisoRadio"]');
    radios.forEach(r => {
      r.addEventListener('change', actualizarEstadoBotones);
    });

    // Si sólo hay un compromiso, seleccionarlo por defecto
    if (radios.length === 1) {
      radios[0].checked = true;
    }

    actualizarEstadoBotones();
  }

  async function cargarCompromisos() {
    setMsg("");
    const caseId = qp("case");
    if (!caseId) {
      panel.innerHTML =
        `<div class="alert alert-warning">No se recibió <b>case</b> en la URL.</div>`;
      actualizarEstadoBotones();
      return;
    }

    try {
      const res = await fetch(`/api/bonita/revisar-compromisos/?case=${encodeURIComponent(caseId)}`);
      const j = await res.json();

      if (!res.ok || j.ok === false) {
        panel.innerHTML =
          `<div class="alert alert-danger">Error al cargar compromisos: ${j.error || res.status}</div>`;
        actualizarEstadoBotones();
        return;
      }

      renderCompromisos(j.compromisos || []);
    } catch (e) {
      panel.innerHTML =
        `<div class="alert alert-danger">Error de red al cargar compromisos.</div>`;
      actualizarEstadoBotones();
    }
  }

  function obtenerCompromisoSeleccionado() {
    const radio = document.querySelector('input[name="compromisoRadio"]:checked');
    return radio ? parseInt(radio.value, 10) : null;
  }

  async function enviarEvaluacion(volverAEvaluar, finalizarPlan) {
    setMsg("");
    const caseId     = qp("case");
    const proyectoId = qp("proyecto");

    if (!caseId) {
      setMsg(`<div class="alert alert-warning">No se encontró <b>caseId</b> en la URL.</div>`);
      return;
    }

    const compId = obtenerCompromisoSeleccionado();

    if (!volverAEvaluar && !compId) {
      setMsg(`
        <div class="alert alert-warning">
          Tenés que seleccionar un compromiso o usar el botón 
          <strong>"Volver a evaluar"</strong>.
        </div>`);
      return;
    }

    btnVolver.disabled    = true;
    btnConfirm.disabled   = true;
    btnConfirmEj.disabled = true;

    try {
      const res = await fetch("/api/bonita/evaluar-propuestas/", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
          caseId: caseId,
          proyectoId: proyectoId ? parseInt(proyectoId, 10) : null,
          compromisoIdSeleccionado: compId,
          volverAEvaluar: volverAEvaluar,
          finalizarPlan: !!finalizarPlan
        })
      });

      const j = await res.json();

      if (!res.ok || j.ok === false) {
        setMsg(`
          <div class="alert alert-danger">
            Error al guardar la evaluación: ${j.error || res.status}
          </div>`);
        return;
      }

      if (volverAEvaluar) {
        setMsg(`
          <div class="alert alert-success">
            Recargando página...
          </div>`);
        setTimeout(() => { location.reload(); }, 1000);
      } else if (finalizarPlan) {
        setMsg(`
          <div class="alert alert-success">
            El compromiso fue aceptado y el plan se marcó como completo.
            Bonita va a continuar el flujo hacia la etapa de ejecución.
          </div>`);
        setTimeout(() => {
          location.href = `/bonita/monitoreo/?case=${encodeURIComponent(caseId)}&proyecto=${encodeURIComponent(proyectoId || "")}`;
        }, 1000);
      } else {
        setMsg(`
          <div class="alert alert-success">
            Evaluación guardada correctamente. El flujo continuará con el compromiso seleccionado.
          </div>`);
        setTimeout(() => { cargarCompromisos(); }, 800);
      }

    } catch (e) {
      setMsg(`
        <div class="alert alert-danger">
          Error de red al guardar la evaluación.
        </div>`);
    } finally {
      btnVolver.disabled = false;
      actualizarEstadoBotones();
    }
  }

  btnVolver.addEventListener("click", () => enviarEvaluacion(true, false));
  btnConfirm.addEventListener("click", () => enviarEvaluacion(false, false));
  btnConfirmEj.addEventListener("click", () => enviarEvaluacion(false, true));

  cargarCompromisos();
</script>

</body>
</html>
