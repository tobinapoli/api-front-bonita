<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Revisar pedidos | ProjectPlanning</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body {
      background: #f5f7fa;
      font-family: "Segoe UI", Roboto, Arial, sans-serif;
    }

    .page-wrapper {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    main {
      flex: 1;
      display: flex;
      justify-content: center;
      padding: 2rem 1rem;
    }

    footer {
      background: rgba(0, 0, 0, 0.04);
      padding: 1rem;
      text-align: center;
      font-size: 0.9rem;
      color: #6b7280;
    }
  </style>
</head>
<body>

<div class="page-wrapper">

  <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container">
      <a class="navbar-brand" href="/bonita/login/">ProjectPlanning</a>
      <div class="ms-auto d-flex gap-2">
        <button id="btnVolver" class="btn btn-outline-light btn-sm">
          Volver a proyectos
        </button>
      </div>
    </div>
  </nav>

  <main>
    <div class="container" style="max-width:900px">
      <div class="card shadow-sm w-100">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
          <h4 class="mb-0">Revisar pedidos</h4>
          <button id="btnCargar" class="btn btn-light btn-sm">Cargar desde Bonita</button>
        </div>
        <div class="card-body">
          <p class="text-muted small mb-3">
            En esta vista pod茅s ver el pedido publicado para este proyecto y colaborar con 茅l.
          </p>

          <div id="panel"></div>
          <div id="msg" class="mt-3"></div>
        </div>
      </div>
    </div>
  </main>

  <footer>
    漏 2025 ProjectPlanning 路 Organizaciones sociales en red
  </footer>

</div>

<script>
  function qp(n) {
    return new URLSearchParams(location.search).get(n);
  }

  //  Solo Red de ONGs puede revisar pedidos
  (function () {
    const rol = qp("rol");
    if (rol && rol !== "red_ongs") {
      document.body.innerHTML =
        '<div class="container py-5"><div class="alert alert-warning">No ten茅s permiso para revisar pedidos.</div></div>';
      throw new Error("No autorizado");
    }
  })();

  const panel = document.getElementById("panel");
  const msg   = document.getElementById("msg");

  function setMsg(html) {
    msg.innerHTML = html || "";
  }

  function formatearFecha(fechaIso) {
    if (!fechaIso) return "";
    const d = new Date(fechaIso);
    if (isNaN(d.getTime())) return fechaIso;
    const mesesCortos = ["ene", "feb", "mar", "abr", "may", "jun", "jul", "ago", "sep", "oct", "nov", "dic"];
    const dia = d.getDate();
    const mes = mesesCortos[d.getMonth()];
    const anio = d.getFullYear();
    return `${dia} de ${mes}, ${anio}`;
  }

  async function cargarPedidos() {
    setMsg("");
    const caseId = qp("case");
    if (!caseId) {
      panel.innerHTML =
        `<div class="alert alert-warning">No se recibi贸 <b>case</b> en la URL.</div>`;
      return;
    }

    const btnCargar = document.getElementById("btnCargar");
    const originalBtnHtml = btnCargar.innerHTML;
    btnCargar.disabled = true;
    btnCargar.innerHTML = `
      <span class="spinner-border spinner-border-sm me-2"></span>
      Cargando...
    `;

    try {
      const res = await fetch(`/api/bonita/revisar-pedidos/?case=${encodeURIComponent(caseId)}`);
      let j;
      try {
        j = await res.json();
      } catch (e) {
        panel.innerHTML =
          `<div class="alert alert-danger">Respuesta inv谩lida del servidor.</div>`;
        return;
      }

      if (!res.ok || j.error) {
        panel.innerHTML =
          `<div class="alert alert-danger">Error: ${j.error || res.status}</div>`;
        return;
      }

      const arr = j.pedidos || [];
      if (arr.length === 0) {
        panel.innerHTML =
          `<div class="alert alert-secondary">No hay pedidos disponibles para este proyecto.</div>`;
        return;
      }

      const html = arr.map(p => {
        const creado   = formatearFecha(p.creado_en);
        const tipoRaw  = p.tipo || "";
        const tipo     = tipoRaw.replace(/_/g, " ");
        const tipoCap  = tipo ? tipo.charAt(0).toUpperCase() + tipo.slice(1) : "Pedido";
        const estado   = p.estado || "";
        const detalle  = p.detalle || "";
        const pedidoId = p.id;

        return `
          <div class="border rounded p-3 mb-3 bg-white">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <div class="d-flex align-items-center gap-2 mb-1">
                  <h5 class="mb-0">${tipoCap}</h5>
                  ${estado ? `<span class="badge bg-light text-muted text-uppercase small">${estado}</span>` : ""}
                </div>
                ${creado ? `<div class="text-muted small">Creado el ${creado}</div>` : ""}
              </div>
              <button
                class="btn btn-sm btn-outline-primary"
                onclick="colaborar(${pedidoId})">
                Colaborar
              </button>
            </div>
            ${detalle ? `<p class="mt-2 mb-0">${detalle}</p>` : ""}
          </div>
        `;
      }).join("");

      panel.innerHTML = html;
    } catch (e) {
      panel.innerHTML =
        `<div class="alert alert-danger">Error al cargar pedidos.</div>`;
    } finally {
      btnCargar.disabled = false;
      btnCargar.innerHTML = originalBtnHtml;
    }
  }

  async function finalizarRevision(verOtroProyecto) {
    const caseId = qp("case");
    if (!caseId) {
      setMsg(`<div class="alert alert-warning">No se encontr贸 <b>caseId</b> en la URL.</div>`);
      return { ok: false };
    }

    const res = await fetch("/api/bonita/revisar-pedidos/finalizar/", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({
        caseId: caseId,
        verOtroProyecto: verOtroProyecto
      })
    });

    let j;
    try {
      j = await res.json();
    } catch (e) {
      setMsg(`<div class="alert alert-danger">Respuesta inv谩lida al finalizar la revisi贸n.</div>`);
      return { ok: false };
    }

    if (!res.ok || j.ok === false) {
      setMsg(`<div class="alert alert-danger">Error al finalizar 'Revisar pedidos': ${j.error || res.status}</div>`);
      return { ok: false };
    }

    return { ok: true };
  }

  async function colaborar(pedidoId) {
    setMsg("");
    const caseId     = qp("case");
    const proyectoId = qp("proyecto");
    const rol        = qp("rol") || "";

    const r = await finalizarRevision(false);
    if (!r.ok) return;

    window.location.href =
      `/bonita/compromiso/?case=${encodeURIComponent(caseId)}&proyecto=${encodeURIComponent(proyectoId)}&pedido=${encodeURIComponent(pedidoId)}&rol=${encodeURIComponent(rol)}`;
  }

  async function volverAProyectos() {
    setMsg("");
    const caseId = qp("case");
    const rol    = qp("rol") || "";

    const r = await finalizarRevision(true);
    if (!r.ok) return;

    window.location.href =
      `/bonita/revisar/?case=${encodeURIComponent(caseId)}&rol=${encodeURIComponent(rol)}`;
  }

  document.getElementById("btnCargar").addEventListener("click", cargarPedidos);
  document.getElementById("btnVolver").addEventListener("click", volverAProyectos);

  cargarPedidos();
  window.colaborar = colaborar;
</script>
</body>
</html>
