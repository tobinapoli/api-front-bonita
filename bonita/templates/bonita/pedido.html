<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Registrar pedido | ProjectPlanning</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-light d-flex flex-column min-vh-100">

<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
  <div class="container">
    <a class="navbar-brand" href="/bonita/login/">ProjectPlanning</a>
  </div>
</nav>

<main class="flex-grow-1">
  <div class="container py-4" style="max-width:720px">
    <div class="card shadow-sm">
      <div class="card-header bg-primary text-white">
        <h3 class="mb-0">Registr√° un nuevo pedido</h3>
      </div>

      <div class="card-body">
        <p class="text-muted mb-3">
          Ingres√° los datos necesarios para registrar un pedido asociado al proyecto.
        </p>

        <form id="pedidoForm">
          <input type="hidden" name="case" value="{{ request.GET.case }}">
          <input type="hidden" name="proyectoId" value="{{ request.GET.proyecto }}">

          <div class="mb-3">
            <label class="form-label fw-bold">Tipo de pedido</label>
            <select class="form-select" name="pedidoTipo" required>
              <option value="">-- Seleccionar tipo --</option>
              <option value="materiales">Materiales</option>
              <option value="mano_obra">Mano de obra</option>
              <option value="servicio">Servicio</option>
              <option value="dinero">Aporte dinerario</option>
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label fw-bold">Detalle</label>
            <textarea
              class="form-control"
              name="pedidoDetalle"
              rows="4"
              placeholder="Ej.: 10 paneles solares de 450W, cables y estructura de montaje"
              required
            ></textarea>
          </div>

          <div class="d-flex justify-content-between align-items-center gap-2">
            <a href="/bonita/login/" class="btn btn-outline-secondary btn-sm">
              Volver
            </a>

            <button type="button" class="btn btn-primary" id="btnGuardar">
              Guardar pedido y pasar a evaluar
            </button>
          </div>
        </form>

        <div id="resultado" class="mt-4"></div>
      </div>
    </div>
  </div>
</main>

<footer class="mt-4 bg-light border-top py-3">
  <div class="container text-center text-muted small">
    ¬© 2025 ProjectPlanning ¬∑ Organizaciones sociales en red
  </div>
</footer>

<script>
  function qp(name) {
    return new URLSearchParams(location.search).get(name);
  }

  // üîê Permisos
  (function () {
    const rol = qp("rol");
    if (rol && rol !== "ong_originante") {
      document.body.innerHTML =
        '<div class="container py-5"><div class="alert alert-warning">No ten√©s permiso para registrar pedidos.</div></div>';
      throw new Error("No autorizado");
    }
  })();

  const form       = document.getElementById("pedidoForm");
  const resultado  = document.getElementById("resultado");
  const btnGuardar = document.getElementById("btnGuardar");

  async function enviarPedido() {
    resultado.innerHTML = "";

    const originalBtnHtml = btnGuardar.innerHTML;
    btnGuardar.disabled = true;
    btnGuardar.innerHTML = `
      <span class="spinner-border spinner-border-sm me-2"></span>
      Guardando...
    `;

    const f = form;

    const payload = {
      caseId: qp("case"),
      proyectoId: qp("proyecto"),
      pedidoTipo: f.pedidoTipo.value,
      pedidoDetalle: f.pedidoDetalle.value
    };

    try {
      const res = await fetch("/api/bonita/pedido/", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      const json = await res.json();

      if (!res.ok || !json.ok) {
        resultado.innerHTML = `
          <div class="alert alert-danger">
            Error al registrar el pedido:<br>
            <code>${json.error || "Error desconocido"}</code>
          </div>
        `;
      } else {
        resultado.innerHTML = `
          <div class="alert alert-success">
            Pedido registrado correctamente...
          </div>
        `;

        setTimeout(() => {
          const caseId     = qp("case");
          const proyectoId = qp("proyecto");
          const rol        = qp("rol") || "ong_originante";

          window.location.href =
            `/bonita/evaluar/?case=${encodeURIComponent(caseId)}&proyecto=${encodeURIComponent(proyectoId)}&rol=${encodeURIComponent(rol)}`;
        }, 1200);
      }
    } catch (err) {
      console.error(err);
      resultado.innerHTML = `
        <div class="alert alert-danger">
          No se pudo contactar con la API.
        </div>
      `;
    } finally {
      btnGuardar.disabled = false;
      btnGuardar.innerHTML = originalBtnHtml;
    }
  }

  btnGuardar.addEventListener("click", enviarPedido);
</script>

</body>
</html>
