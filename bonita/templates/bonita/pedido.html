<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Registrar pedido</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-light">

<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
  <div class="container">
    <a class="navbar-brand" href="/bonita/login/">ProjectPlanning</a>
  </div>
</nav>

<div class="container py-4" style="max-width:720px">
  <div class="card shadow-sm">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
      <h4 class="mb-0">Registrar nuevo pedido</h4>
      <span class="badge bg-light text-primary small">
        Proyecto #{{ request.GET.proyecto }}
      </span>
    </div>

    <div class="card-body">

      <form id="pedidoForm">
        <input type="hidden" name="case" value="{{ request.GET.case }}">
        <input type="hidden" name="proyectoId" value="{{ request.GET.proyecto }}">

        <div class="mb-3">
          <label class="form-label fw-bold">Tipo de pedido</label>
          <select class="form-select" name="pedidoTipo" required>
            <option value="">-- Seleccionar tipo --</option>
            <option value="materiales">Materiales</option>
            <option value="mano_obra">Mano de obra</option>
            <option value="servicio">Servicio</option>
            <option value="dinero">Aporte dinerario</option>
          </select>
        </div>

        <div class="mb-3">
          <label class="form-label fw-bold">Detalle</label>
          <textarea
            class="form-control"
            name="pedidoDetalle"
            rows="4"
            placeholder="Ej.: 10 paneles solares de 450W, cables y estructura de montaje"
            required
          ></textarea>
        </div>

        <div class="d-flex justify-content-between align-items-center gap-2">
          <a href="/bonita/login/" class="btn btn-outline-secondary btn-sm">
            Volver
          </a>

          <div class="d-flex gap-2">
            <button type="button" class="btn btn-secondary" id="btnOtro">
              Guardar y agregar otro
            </button>
            <button type="button" class="btn btn-primary" id="btnEvaluar">
              Guardar y pasar a evaluar
            </button>
          </div>
        </div>
      </form>

      <div id="resultado" class="mt-4"></div>

    </div>
  </div>
</div>

<script>
  function qp(name){ return new URLSearchParams(location.search).get(name); }

  // üîê Solo ONG originante puede registrar pedidos
  (function () {
    const rol = qp("rol");
    if (rol && rol !== "ong_originante") {
      document.body.innerHTML =
        '<div class="container py-5"><div class="alert alert-warning">No ten√©s permiso para registrar pedidos.</div></div>';
      throw new Error("No autorizado");
    }
  })();

  const form       = document.getElementById("pedidoForm");
  const resultado  = document.getElementById("resultado");
  const btnOtro    = document.getElementById("btnOtro");
  const btnEvaluar = document.getElementById("btnEvaluar");

  async function enviarPedido(crearOtroPedido) {
    resultado.innerHTML = "";

    btnOtro.disabled    = true;
    btnEvaluar.disabled = true;

    const f = form;

    const payload = {
      caseId:       qp("case"),
      proyectoId:   qp("proyecto"),
      pedidoTipo:   f.pedidoTipo.value,
      pedidoDetalle:f.pedidoDetalle.value,
      crearOtroPedido: crearOtroPedido
    };

    try {
      const res = await fetch("/api/bonita/pedido/", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      const json = await res.json();

      if (!res.ok || !json.ok) {
        resultado.innerHTML = `
          <div class="alert alert-danger">
            Error al registrar el pedido:<br>
            <code>${json.error || "Error desconocido"}</code>
          </div>
        `;
      } else {
        if (crearOtroPedido) {
          resultado.innerHTML = `
            <div class="alert alert-success">
              Pedido registrado correctamente. Pod√©s cargar otro pedido.
            </div>
          `;
          f.reset();
        } else {
          resultado.innerHTML = `
            <div class="alert alert-success">
              Pedido registrado. Avanzando a la siguiente etapa...
            </div>
          `;
          setTimeout(() => {
            const caseId     = qp("case");
            const proyectoId = qp("proyecto");
            const rol        = qp("rol") || "ong_originante";

            window.location.href =
              `/bonita/evaluar/?case=${encodeURIComponent(caseId)}&proyecto=${encodeURIComponent(proyectoId)}&rol=${encodeURIComponent(rol)}`;
          }, 1200);
        }
      }
    } catch (err) {
      resultado.innerHTML = `
        <div class="alert alert-danger">
          No se pudo contactar con la API de pedidos.
        </div>
      `;
    } finally {
      btnOtro.disabled    = false;
      btnEvaluar.disabled = false;
    }
  }

  btnOtro.addEventListener("click",   () => enviarPedido(true));
  btnEvaluar.addEventListener("click",() => enviarPedido(false));
</script>

</body>
</html>