<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Revisar proyectos | ProjectPlanning</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
  <div class="container">
    <a class="navbar-brand" href="/bonita/login/">ProjectPlanning</a>

    <!-- Bot贸n para terminar la colaboraci贸n de la red -->
    <button id="btnSalirRed" class="btn btn-outline-light btn-sm ms-auto" onclick="salirRed()">
      Cerrar sesi贸n Red de ONGs
    </button>
  </div>
</nav>

<div class="container py-4" style="max-width:900px">
  <div class="card shadow-sm">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
      <div>
        <h4 class="mb-0">Revis谩 los proyectos publicados</h4>
      </div>
      <button id="btnCargar" class="btn btn-light btn-sm">
        Cargar desde Bonita
      </button>
    </div>
    <div class="card-body">
      <p class="text-muted small mb-3">
        En esta vista pod茅s revisar proyectos en <strong>planificaci贸n</strong>, <strong>ejecuci贸n</strong> y
        <strong>finalizados</strong>
      </p>

      <div id="panel"></div>
      <div id="msg" class="mt-3"></div>
    </div>
  </div>
</div>

<footer class="mt-4 bg-light border-top py-3">
  <div class="container text-center text-muted small">
    漏 2025 ProjectPlanning 路 Organizaciones sociales en red
  </div>
</footer>

<script>
  function qp(n){ return new URLSearchParams(location.search).get(n); }

  //  Solo Red de ONGs puede revisar proyectos
  (function () {
    const rol = qp("rol");
    if (rol && rol !== "red_ongs") {
      document.body.innerHTML =
        '<div class="container py-5"><div class="alert alert-warning">No ten茅s permiso para revisar proyectos.</div></div>';
      throw new Error("No autorizado");
    }
  })();

  const panel = document.getElementById("panel");
  const msg   = document.getElementById("msg");

  function setMsg(html) {
    msg.innerHTML = html || "";
  }

  function normalizarEstado(raw) {
    if (!raw) return "";
    return String(raw).trim().toLowerCase();
  }

  function etiquetaEstado(p) {
    const e = normalizarEstado(p.estado);
    if (e === "planificacion") return "En planificaci贸n";
    if (e === "ejecucion")     return "En ejecuci贸n";
    if (e === "finalizado")    return "Finalizado";
    return "Estado desconocido";
  }

  function claseBadgeEstado(p) {
    const e = normalizarEstado(p.estado);
    if (e === "planificacion") return "bg-secondary";
    if (e === "ejecucion")     return "bg-success";
    if (e === "finalizado")    return "bg-dark";
    return "bg-light text-dark";
  }

  function textoAccion(p) {
    const e = normalizarEstado(p.estado);
    if (e === "planificacion") {
      return "Pod茅s revisar los pedidos y ofrecer compromisos.";
    }
    if (e === "ejecucion") {
      return "El proyecto est谩 en ejecuci贸n: pod茅s monitorear su avance.";
    }
    if (e === "finalizado") {
      return "El proyecto est谩 finalizado: pod茅s ver el detalle y el historial.";
    }
    return "";
  }

  async function cargar() {
    setMsg("");
    const caseId = qp("case");
    if (!caseId) {
      panel.innerHTML =
        `<div class="alert alert-warning">No se recibi贸 <b>case</b> en la URL.</div>`;
      return;
    }

    const btnCargar = document.getElementById("btnCargar");
    const originalBtnHtml = btnCargar.innerHTML;
    btnCargar.disabled = true;
    btnCargar.innerHTML = `
      <span class="spinner-border spinner-border-sm me-2"></span>
      Cargando...
    `;

    try {
      const res = await fetch(`/api/bonita/revisar/?case=${encodeURIComponent(caseId)}`);
      const j = await res.json();

      if (!res.ok || !j.ok) {
        panel.innerHTML =
          `<div class="alert alert-danger">Error: ${j.error || res.status}</div>`;
        return;
      }

      const lista = j.proyectos || [];

      if (lista.length === 0) {
        panel.innerHTML =
          `<div class="alert alert-secondary">No hay proyectos para este caso.</div>`;
        return;
      }

      const html = lista.map(p => {
        const estado = normalizarEstado(p.estado);
        const nombre = p.nombre || "Proyecto sin nombre";
        const desc   = p.descripcion || "";
        const idp    = p.id;

        let botonHTML = "";

        if (estado === "planificacion") {
          botonHTML = `
            <button class="btn btn-sm btn-outline-primary"
                    onclick="verPedidos(${idp}, this)">
              Ver pedidos
            </button>`;
        } else if (estado === "ejecucion") {
          botonHTML = `
            <button class="btn btn-sm btn-outline-success"
                    onclick="verMonitoreo(${idp})">
              Monitorear
            </button>`;
        } else if (estado === "finalizado") {
          botonHTML = `
            <button class="btn btn-sm btn-outline-dark"
                    onclick="verMonitoreo(${idp})">
              Ver detalle
            </button>`;
        }

        return `
          <div class="border rounded p-3 mb-2 bg-white">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <h5 class="mb-1">${nombre}</h5>
                <span class="badge ${claseBadgeEstado(p)}">${etiquetaEstado(p)}</span>
              </div>
              ${botonHTML}
            </div>

            ${desc ? `<p class="mt-2 mb-1">${desc}</p>` : ""}
            <div class="small text-muted">${textoAccion(p)}</div>
          </div>
        `;
      }).join("");

      panel.innerHTML = html;
    } catch (err) {
      panel.innerHTML =
        `<div class="alert alert-danger">Error al cargar proyectos.</div>`;
    } finally {
      btnCargar.disabled = false;
      btnCargar.innerHTML = originalBtnHtml;
    }
  }

  // Seleccionar proyecto y avanzar a "Ver pedidos"
  async function verPedidos(proyectoId, btnEl) {
    const caseId = qp("case");
    const rol    = qp("rol") || "red_ongs";

    if (!caseId) {
      setMsg(`<div class="alert alert-warning">No se encontr贸 <b>caseId</b> en la URL.</div>`);
      return;
    }

    setMsg("");

    let originalHtml = "";
    if (btnEl) {
      originalHtml = btnEl.innerHTML;
      btnEl.disabled = true;
      btnEl.innerHTML = `
        <span class="spinner-border spinner-border-sm me-2"></span>
        Abriendo...
      `;
      // marcamos el bot贸n como "en carga" para poder restaurarlo si se vuelve con el back
      btnEl.dataset.loading = "1";
      btnEl.dataset.originalHtml = originalHtml;
    }

    try {
      const res = await fetch("/api/bonita/elegir-proyecto/", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ caseId, proyectoId })
      });

      const j = await res.json();
      if (!res.ok || !j.ok) {
        setMsg(
          `<div class="alert alert-danger">Error al seleccionar proyecto: ${j.error || res.status}</div>`
        );
        if (btnEl) {
          btnEl.disabled = false;
          btnEl.innerHTML = originalHtml;
          delete btnEl.dataset.loading;
          delete btnEl.dataset.originalHtml;
        }
        return;
      }

      const url =
        `/bonita/ver-pedidos/?case=${encodeURIComponent(caseId)}&proyecto=${encodeURIComponent(proyectoId)}&rol=${encodeURIComponent(rol)}`;
      location.href = url;
    } catch (err) {
      setMsg(
        `<div class="alert alert-danger">No se pudo contactar con el servidor.</div>`
      );
      if (btnEl) {
        btnEl.disabled = false;
        btnEl.innerHTML = originalHtml;
        delete btnEl.dataset.loading;
        delete btnEl.dataset.originalHtml;
      }
    }
  }

  function verMonitoreo(proyectoId) {
    const caseId = qp("case");
    if (!caseId) {
      setMsg(`<div class="alert alert-warning">No se encontr贸 <b>caseId</b> en la URL.</div>`);
      return;
    }
    location.href =
      `/bonita/monitoreo/?case=${encodeURIComponent(caseId)}&proyecto=${encodeURIComponent(proyectoId)}&rol=red_ongs`;
  }

  // Terminar colaboraci贸n de la Red de ONGs
  async function salirRed() {
    const caseId = qp("case");
    if (!caseId) {
      alert("No se encontr贸 el caseId en la URL.");
      return;
    }

    if (!confirm("驴Seguro que quer茅s terminar la colaboraci贸n de la Red de ONGs para este caso?")) {
      return;
    }

    const btn = document.getElementById("btnSalirRed");
    const original = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = `
      <span class="spinner-border spinner-border-sm me-2"></span>
      Cerrando...
    `;

    setMsg("");

    try {
      const res = await fetch("/api/bonita/red-ongs/salir/", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ caseId })
      });

      let j;
      try {
        j = await res.json();
      } catch {
        j = { ok: false, error: "Respuesta inv谩lida del servidor" };
      }

      if (!res.ok || j.ok === false) {
        setMsg(
          `<div class="alert alert-danger">Error al finalizar colaboraci贸n: ${j.error || res.status}</div>`
        );
        btn.disabled = false;
        btn.innerHTML = original;
        return;
      }

      setMsg(
        `<div class="alert alert-success">La Red de ONGs finaliz贸 su colaboraci贸n en este caso.</div>`
      );
      setTimeout(() => {
        window.location.href = "/bonita/login/";
      }, 1500);
    } catch (err) {
      setMsg(
        `<div class="alert alert-danger">No se pudo contactar con el servidor.</div>`
      );
      btn.disabled = false;
      btn.innerHTML = original;
    }
  }

  document.getElementById("btnCargar").addEventListener("click", cargar);
  cargar();

  // Cuando volv茅s con el bot贸n "Atr谩s", restaurar botones que hayan quedado en modo carga
  window.addEventListener("pageshow", function () {
    const loadingButtons = document.querySelectorAll("button[data-loading='1']");
    loadingButtons.forEach(btn => {
      const original = btn.dataset.originalHtml || "Ver pedidos";
      btn.disabled = false;
      btn.innerHTML = original;
      delete btn.dataset.loading;
      delete btn.dataset.originalHtml;
    });
  });

  // Exponer funciones para onclick en HTML
  window.verPedidos   = verPedidos;
  window.verMonitoreo = verMonitoreo;
  window.salirRed     = salirRed;
</script>
</body>
</html>
