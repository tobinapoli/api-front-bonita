<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Evaluar propuestas</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
  <div class="container">
    <a class="navbar-brand" href="/bonita/login/">ProjectPlanning</a>
  </div>
</nav>

<div class="container py-4" style="max-width:960px">
  <div class="card shadow-sm">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
      <h4 class="mb-0">Evaluar propuestas</h4>
      <div class="text-end small">
        {% if case %}
          <div>Caso: <code>{{ case }}</code></div>
        {% endif %}
        {% if proyecto %}
          <div>Proyecto: <code>{{ proyecto }}</code></div>
        {% endif %}
      </div>
    </div>

    <div class="card-body">
      <div class="alert alert-info">
        Ac√° la ONG originante puede evaluar los compromisos recibidos para sus pedidos.
        Si todav√≠a no hay compromisos, pod√©s usar <strong>‚ÄúVolver a evaluar‚Äù</strong>
        para que el flujo vuelva a esta tarea cuando existan nuevas propuestas.
      </div>

      <div id="panelCompromisos" class="mb-3"></div>

      <div class="d-flex justify-content-between mt-4">
        <a href="/bonita/login/" class="btn btn-outline-secondary btn-sm">
          Volver al inicio
        </a>

        <div class="d-flex gap-2">
          <!-- Bot√≥n que manda volverAEvaluar = true -->
          <button id="btnVolverEvaluar" class="btn btn-outline-primary btn-sm" type="button">
            Volver a evaluar
          </button>

          <!-- Bot√≥n que confirma selecci√≥n (volverAEvaluar = false) -->
          <button id="btnConfirmar" class="btn btn-success btn-sm" type="button">
            Confirmar selecci√≥n
          </button>
        </div>
      </div>

      <div id="msg" class="mt-3"></div>
    </div>
  </div>
</div>

<script>
  function qp(n) {
    return new URLSearchParams(location.search).get(n);
  }

  const panel = document.getElementById("panelCompromisos");
  const msg   = document.getElementById("msg");
  const btnVolver   = document.getElementById("btnVolverEvaluar");
  const btnConfirm  = document.getElementById("btnConfirmar");

  function setMsg(html) {
    msg.innerHTML = html || "";
  }

  // ----- Render de compromisos -----
  function renderCompromisos(lista) {
    if (!lista || lista.length === 0) {
      panel.innerHTML = `
        <div class="alert alert-secondary">
          No hay compromisos para este pedido todav√≠a.
          Pod√©s usar el bot√≥n <strong>"Volver a evaluar m√°s tarde"</strong> y guardar.
        </div>`;
      return;
    }

    const html = lista.map(c => {
      const detalle = c.detalle || "";
      const monto   = (c.monto !== null && c.monto !== undefined)
        ? `Monto ofrecido: <strong>${c.monto}</strong><br>`
        : "";
      const fecha   = c.fecha ? `Fecha: <strong>${c.fecha}</strong><br>` : "";
      const estado  = c.estado ? `Estado: <strong>${c.estado}</strong>` : "";

      return `
        <div class="border rounded p-3 mb-2">
          <div class="form-check d-flex justify-content-between align-items-center">
            <div>
              <input class="form-check-input me-2"
                     type="radio"
                     name="compromisoRadio"
                     id="comp_${c.id}"
                     value="${c.id}">
              <label class="form-check-label" for="comp_${c.id}">
                <strong>Compromiso #${c.id}</strong>
                <div class="small text-muted mt-1">
                  ${detalle ? `${detalle}<br>` : ""}
                  ${monto}${fecha}${estado}
                </div>
              </label>
            </div>

            <button type="button"
                    class="btn btn-sm btn-outline-success"
                    onclick="aceptarCompromisoDesdeCard(${c.id})">
              Aceptar
            </button>
          </div>
        </div>
      `;
    }).join("");

    panel.innerHTML = `
      <h5 class="mb-3">Propuestas recibidas</h5>
      ${html}
    `;
  }

  // ----- Carga de compromisos desde la API -----
  async function cargarCompromisos() {
    setMsg("");
    const caseId = qp("case");
    if (!caseId) {
      panel.innerHTML =
        `<div class="alert alert-warning">No se recibi√≥ <b>case</b> en la URL.</div>`;
      return;
    }

    try {
      const res = await fetch(`/api/bonita/revisar-compromisos/?case=${encodeURIComponent(caseId)}`);
      const j = await res.json();

      if (!res.ok || j.ok === false) {
        panel.innerHTML =
          `<div class="alert alert-danger">Error al cargar compromisos: ${j.error || res.status}</div>`;
        return;
      }

      renderCompromisos(j.compromisos || []);
    } catch (e) {
      panel.innerHTML =
        `<div class="alert alert-danger">Error de red al cargar compromisos.</div>`;
    }
  }

  function obtenerCompromisoSeleccionado() {
    const radio = document.querySelector('input[name="compromisoRadio"]:checked');
    return radio ? parseInt(radio.value, 10) : null;
  }

  // Aceptar desde el bot√≥n de la tarjeta
  function aceptarCompromisoDesdeCard(id) {
    const radio = document.getElementById(`comp_${id}`);
    if (radio) {
      radio.checked = true;
    }
    // Reutiliza el mismo flujo de "Confirmar selecci√≥n"
    enviarEvaluacion(false);
  }

  // Exponerla al scope global para el onclick del HTML
  window.aceptarCompromisoDesdeCard = aceptarCompromisoDesdeCard;

  // ----- Enviar decisi√≥n a la API -----
  async function enviarEvaluacion(volverAEvaluar) {
    setMsg("");
    const caseId     = qp("case");
    const proyectoId = qp("proyecto");

    if (!caseId) {
      setMsg(`<div class="alert alert-warning">No se encontr√≥ <b>caseId</b> en la URL.</div>`);
      return;
    }

    const compId = obtenerCompromisoSeleccionado();

    // Si NO quiere volver a evaluar y tampoco eligi√≥ compromiso, avisamos
    if (!volverAEvaluar && !compId) {
      setMsg(`
        <div class="alert alert-warning">
          Ten√©s que seleccionar un compromiso o usar el bot√≥n 
          <strong>"Volver a evaluar m√°s tarde"</strong>.
        </div>`);
      return;
    }

    btnVolver.disabled  = true;
    btnConfirm.disabled = true;

    try {
      const res = await fetch("/api/bonita/evaluar-propuestas/", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
          caseId: caseId,
          proyectoId: proyectoId ? parseInt(proyectoId, 10) : null,
          compromisoIdSeleccionado: compId,
          volverAEvaluar: volverAEvaluar
        })
      });

      const j = await res.json();

      if (!res.ok || j.ok === false) {
        setMsg(`
          <div class="alert alert-danger">
            Error al guardar la evaluaci√≥n: ${j.error || res.status}
          </div>`);
        return;
      }

      if (volverAEvaluar) {
        setMsg(`
          <div class="alert alert-success">
            Recargando pagina..
          </div>`);

        // üî• Recargar la p√°gina despu√©s de que Bonita vuelva a dejar la tarea en ready
        setTimeout(() => {
          location.reload();
        }, 1000);
      } else {
        setMsg(`
          <div class="alert alert-success">
            Evaluaci√≥n guardada correctamente. El flujo continuar√° con el compromiso seleccionado.
          </div>`);
      }

    } catch (e) {
      setMsg(`
        <div class="alert alert-danger">
          Error de red al guardar la evaluaci√≥n.
        </div>`);
    } finally {
      btnVolver.disabled  = false;
      btnConfirm.disabled = false;
    }
  }

  btnVolver.addEventListener("click", () => enviarEvaluacion(true));
  btnConfirm.addEventListener("click", () => enviarEvaluacion(false));

  cargarCompromisos();
</script>

</body>
</html>
