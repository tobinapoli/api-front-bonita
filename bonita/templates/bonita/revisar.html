<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Revisar proyectos</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
  <div class="container">
    <a class="navbar-brand" href="/bonita/login/">ProjectPlanning</a>

    <!-- NUEVO: bot贸n para terminar la colaboraci贸n de la red -->
    <button id="btnSalirRed" class="btn btn-outline-light btn-sm ms-auto" onclick="salirRed()">
      Cerrar sesi贸n Red de ONGs
    </button>
  </div>
</nav>

<div class="container py-4" style="max-width:900px">
  <div class="card shadow-sm">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
      <h4 class="mb-0">Revisar proyectos</h4>
      <button id="btnCargar" class="btn btn-light btn-sm">Cargar desde Bonita</button>
    </div>
    <div class="card-body">
      <div class="alert alert-info mb-3">
        Caso: <code id="caseOut">{{ request.GET.case }}</code>
        <div class="small mt-2">
          Esta vista muestra proyectos en <strong>planificaci贸n</strong> y <strong>ejecuci贸n</strong>.
          Los proyectos <strong>finalizados</strong> no se muestran porque ya no admiten interacci贸n.
        </div>
      </div>
      <div id="panel"></div>
      <div id="msg" class="mt-3"></div>
    </div>
  </div>
</div>

<script>
  function qp(n){ return new URLSearchParams(location.search).get(n); }

  //  Solo Red de ONGs puede revisar proyectos
  (function () {
    const rol = qp("rol");
    if (rol && rol !== "red_ongs") {
      document.body.innerHTML =
        '<div class="container py-5"><div class="alert alert-warning">No ten茅s permiso para revisar proyectos.</div></div>';
      throw new Error("No autorizado");
    }
  })();

  const panel = document.getElementById("panel");
  const msg   = document.getElementById("msg");

  function setMsg(html) {
    msg.innerHTML = html || "";
  }

  function normalizarEstado(raw) {
    if (!raw) return "";
    return String(raw).trim().toLowerCase();
  }

  function etiquetaEstado(p) {
    const e = normalizarEstado(p.estado);
    if (e === "planificacion") return "En planificaci贸n";
    if (e === "ejecucion")     return "En ejecuci贸n";
    if (e === "finalizado")    return "Finalizado";
    return "Estado desconocido";
  }

  function claseBadgeEstado(p) {
    const e = normalizarEstado(p.estado);
    if (e === "planificacion") return "bg-secondary";
    if (e === "ejecucion")     return "bg-success";
    if (e === "finalizado")    return "bg-dark";
    return "bg-light text-dark";
  }

  function textoAccion(p) {
    const e = normalizarEstado(p.estado);
    if (e === "planificacion") {
      return "Pod茅s revisar los pedidos y ofrecer compromisos.";
    }
    if (e === "ejecucion") {
      return "El proyecto est谩 en ejecuci贸n: pod茅s monitorear su avance.";
    }
    return "";
  }

  async function cargar() {
    setMsg("");
    const caseId = qp("case");
    if (!caseId) {
      panel.innerHTML =
        `<div class="alert alert-warning">No se recibi贸 <b>case</b> en la URL.</div>`;
      return;
    }

    const res = await fetch(`/api/bonita/revisar/?case=${encodeURIComponent(caseId)}`);
    const j = await res.json();

    if (!res.ok || !j.ok) {
      panel.innerHTML =
        `<div class="alert alert-danger">Error: ${j.error || res.status}</div>`;
      return;
    }

    const lista = (j.proyectos || []).filter(
      p => normalizarEstado(p.estado) !== "finalizado"
    );

    if (lista.length === 0) {
      panel.innerHTML =
        `<div class="alert alert-secondary">No hay proyectos en planificaci贸n o ejecuci贸n.</div>`;
      return;
    }

    const html = lista.map(p => {
      const estado = normalizarEstado(p.estado);
      const nombre = p.nombre || "Proyecto sin nombre";
      const desc   = p.descripcion || "";
      const idp    = p.id;

      let botonHTML = "";

      if (estado === "planificacion") {
        botonHTML = `
          <button class="btn btn-sm btn-outline-primary"
                  onclick="verPedidos(${idp})">
            Ver pedidos
          </button>`;
      }

      if (estado === "ejecucion") {
        botonHTML = `
          <button class="btn btn-sm btn-outline-success"
                  onclick="verMonitoreo(${idp})">
            Monitorear
          </button>`;
      }

      return `
        <div class="border rounded p-3 mb-2">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <h5 class="mb-1">${nombre}</h5>
              <div class="text-muted small">ID: <strong>${idp}</strong></div>
              <span class="badge ${claseBadgeEstado(p)}">${etiquetaEstado(p)}</span>
            </div>
            ${botonHTML}
          </div>

          ${desc ? `<p class="mt-2 mb-1">${desc}</p>` : ""}
          <div class="small text-muted">${textoAccion(p)}</div>
        </div>
      `;
    }).join("");

    panel.innerHTML = html;
  }

  // Igual que antes: elige proyecto y dispara la tarea 'Revisar proyectos'
  async function verPedidos(proyectoId) {
    const caseId = qp("case");
    const rol    = qp("rol") || "red_ongs";

    if (!caseId) {
      setMsg(`<div class="alert alert-warning">No se encontr贸 <b>caseId</b> en la URL.</div>`);
      return;
    }

    setMsg("");

    const res = await fetch("/api/bonita/elegir-proyecto/", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({ caseId, proyectoId })
    });

    const j = await res.json();
    if (!res.ok || !j.ok) {
      setMsg(
        `<div class="alert alert-danger">Error al seleccionar proyecto: ${j.error || res.status}</div>`
      );
      return;
    }

    const url =
      `/bonita/ver-pedidos/?case=${encodeURIComponent(caseId)}&proyecto=${encodeURIComponent(proyectoId)}&rol=${encodeURIComponent(rol)}`;
    location.href = url;
  }

  function verMonitoreo(proyectoId) {
    const caseId = qp("case");
    if (!caseId) {
      setMsg(`<div class="alert alert-warning">No se encontr贸 <b>caseId</b> en la URL.</div>`);
      return;
    }
    location.href =
      `/bonita/monitoreo/?case=${encodeURIComponent(caseId)}&proyecto=${encodeURIComponent(proyectoId)}&rol=red_ongs`;
  }

  // NUEVO: terminar colaboraci贸n de la Red de ONGs (seguirColaborando = false)
  async function salirRed() {
    const caseId = qp("case");
    if (!caseId) {
      alert("No se encontr贸 el caseId en la URL.");
      return;
    }

    if (!confirm("驴Seguro que quer茅s terminar la colaboraci贸n de la Red de ONGs para este caso?")) {
      return;
    }

    setMsg("");

    const res = await fetch("/api/bonita/red-ongs/salir/", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({ caseId })
    });

    let j;
    try {
      j = await res.json();
    } catch {
      j = { ok: false, error: "Respuesta inv谩lida del servidor" };
    }

    if (!res.ok || j.ok === false) {
      setMsg(
        `<div class="alert alert-danger">Error al finalizar colaboraci贸n: ${j.error || res.status}</div>`
      );
      return;
    }

    setMsg(
      `<div class="alert alert-success">La Red de ONGs finaliz贸 su colaboraci贸n en este caso.</div>`
    );
    setTimeout(() => {
      window.location.href = "/bonita/login/";
    }, 1500);
  }

  document.getElementById("btnCargar").addEventListener("click", cargar);
  cargar();

  window.verPedidos   = verPedidos;
  window.verMonitoreo = verMonitoreo;
  window.salirRed     = salirRed;
</script>
</body>
</html>