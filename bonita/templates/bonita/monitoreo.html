<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Monitoreo del proyecto | ProjectPlanning</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
  <div class="container">
    <a class="navbar-brand" href="/bonita/login/">ProjectPlanning</a>
  </div>
</nav>

<div class="container py-4" style="max-width:960px">
  <div class="card shadow-sm">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
      <h4 class="mb-0">Monitoreo del proyecto</h4>
    </div>

    <div class="card-body">
      <div id="msg" class="mb-3"></div>

      <section class="mb-4">
        <h5>Informaci√≥n del proyecto</h5>
        <div class="border rounded p-3 bg-light">
          <p class="mb-1"><strong>Nombre:</strong> <span id="pNombre">-</span></p>
          <p class="mb-1"><strong>Descripci√≥n:</strong> <span id="pDescripcion">-</span></p>
        </div>
      </section>

      <section class="mb-4">
        <h5>Plan de trabajo</h5>
        <div class="table-responsive">
          <table class="table table-sm table-striped align-middle">
            <thead>
              <tr>
                <th>Etapa</th>
                <th>Fecha inicio</th>
                <th>Fecha fin</th>
              </tr>
            </thead>
            <tbody id="tablaEtapas">
              <tr><td colspan="3" class="text-muted">Sin etapas registradas.</td></tr>
            </tbody>
          </table>
        </div>
      </section>

      <section>
        <h5>Compromisos aceptados</h5>
        <div id="listaCompromisos">
          <div class="alert alert-secondary mb-0">
            Todav√≠a no hay compromisos aceptados registrados en este proyecto.
          </div>
        </div>
      </section>

      <section class="mt-4">
        <h5>Historial de Observaciones del Consejo Directivo</h5>
        <div id="historialObservaciones">
          <div class="alert alert-secondary mb-0">
            No hay observaciones registradas para este proyecto.
          </div>
        </div>
      </section>

      <div class="mt-4 d-flex justify-content-between">
        <a href="/bonita/login/" class="btn btn-outline-secondary btn-sm">
          Volver al inicio
        </a>

        <a id="btnVolverProyecto" href="#" class="btn btn-outline-primary btn-sm">
          Volver a Evaluar / Agregar Compromisos
        </a>
      </div>

      <div class="mt-3 text-end" id="divFinalizar">
        <button class="btn btn-success" id="btnFinalizarProyecto" onclick="finalizarProyecto()">
          Finalizar Proyecto
        </button>
      </div>
    </div>
  </div>
</div>

<footer class="mt-4 bg-light border-top py-3">
  <div class="container text-center text-muted small">
    ¬© 2025 ProjectPlanning ¬∑ Organizaciones sociales en red
  </div>
</footer>

<!-- Modal para responder observaciones -->
<div class="modal fade" id="modalResponder" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title">Responder a Observaci√≥n del Consejo</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-warning">
          <strong>Observaci√≥n recibida:</strong>
          <p class="mb-0 mt-2" id="textoObservacionModal" style="font-style: italic;">...</p>
        </div>

        <form id="formResponder">
          <input type="hidden" id="idObservacionResponder">
          <div class="mb-3">
            <label for="textoRespuesta" class="form-label fw-bold">Tu Respuesta / Plan de acci√≥n:</label>
            <textarea id="textoRespuesta" class="form-control" rows="5" required placeholder="Describe c√≥mo vas a solucionar lo se√±alado por el Consejo..."></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-danger" onclick="enviarRespuesta()">
          Enviar Respuesta
        </button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  function qp(n) {
    return new URLSearchParams(location.search).get(n);
  }

  function formatearFecha(fechaIso) {
    if (!fechaIso) return "";
    const d = new Date(fechaIso);
    if (isNaN(d.getTime())) return fechaIso;
    const mesesCortos = ["ene", "feb", "mar", "abr", "may", "jun", "jul", "ago", "sep", "oct", "nov", "dic"];
    const dia = d.getDate();
    const mes = mesesCortos[d.getMonth()];
    const anio = d.getFullYear();
    return `${dia} de ${mes}, ${anio}`;
  }

  const msg               = document.getElementById("msg");
  const pNombre           = document.getElementById("pNombre");
  const pDescripcion      = document.getElementById("pDescripcion");
  const tablaEtapas       = document.getElementById("tablaEtapas");
  const listaCompromisos  = document.getElementById("listaCompromisos");
  const historialObservaciones = document.getElementById("historialObservaciones");
  const btnVolverProyecto = document.getElementById("btnVolverProyecto");
  const btnFinalizarProyecto = document.getElementById("btnFinalizarProyecto");
  const divFinalizar      = document.getElementById("divFinalizar");

  let modalResponder = null;

  document.addEventListener('DOMContentLoaded', function() {
    modalResponder = new bootstrap.Modal(document.getElementById('modalResponder'));
    cargarResumen();
  });

  function setMsg(html) {
    msg.innerHTML = html || "";
  }

  async function cargarResumen() {
    const caseId     = qp("case");
    const proyectoId = qp("proyecto");
    const rol        = qp("rol") || "";

    if (!caseId || !proyectoId) {
      setMsg('<div class="alert alert-warning">Faltan par√°metros <b>case</b> o <b>proyecto</b> en la URL.</div>');
      return;
    }

    // Configurar bot√≥n seg√∫n rol
    if (rol === "red_ongs") {
      btnVolverProyecto.textContent = "Volver a proyectos";
      btnVolverProyecto.href =
        `/bonita/revisar/?case=${encodeURIComponent(caseId)}&rol=red_ongs`;
      // La Red de ONGs NO puede finalizar proyectos: ocultar el bot√≥n
      if (divFinalizar) {
        divFinalizar.style.display = "none";
      }
    } else {
      btnVolverProyecto.textContent = "Volver al proyecto";
      btnVolverProyecto.href =
        `/bonita/evaluar/?case=${encodeURIComponent(caseId)}&proyecto=${encodeURIComponent(proyectoId)}&rol=ong_originante`;
    }

    try {
      const res = await fetch(
        `/api/bonita/resumen-proyecto/?case=${encodeURIComponent(caseId)}&proyecto=${encodeURIComponent(proyectoId)}`
      );
      const j = await res.json();

      if (!res.ok || j.ok === false) {
        setMsg(`<div class="alert alert-danger">Error al cargar el resumen: ${j.error || res.status}</div>`);
        return;
      }

      // 1. Datos b√°sicos
      pNombre.textContent      = j.nombreProyecto || "-";
      pDescripcion.textContent = j.descripcion || "-";

      const etapas = j.etapas || [];
      if (!etapas.length) {
        tablaEtapas.innerHTML =
          '<tr><td colspan="3" class="text-muted">Sin etapas registradas.</td></tr>';
      } else {
        tablaEtapas.innerHTML = etapas.map(e => {
          const ini = e.fechaInicioPrevista ? formatearFecha(e.fechaInicioPrevista) : "-";
          const fin = e.fechaFinPrevista ? formatearFecha(e.fechaFinPrevista) : "-";
          return `
            <tr>
              <td>${e.nombre || "-"}</td>
              <td>${ini}</td>
              <td>${fin}</td>
            </tr>
          `;
        }).join("");
      }

      const compromisos = j.compromisosAceptados || [];
      if (!compromisos.length) {
        listaCompromisos.innerHTML = `
          <div class="alert alert-secondary mb-0">
            Todav√≠a no hay compromisos aceptados registrados en este proyecto.
          </div>`;
      } else {
        const html = compromisos.map(c => {
          const fecha = c.fecha ? `Fecha: <strong>${formatearFecha(c.fecha)}</strong><br>` : "";
          return `
            <div class="border rounded p-3 mb-2">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <strong>Descripci√≥n del compromiso:</strong>
                  <div class="small text-muted mt-1">
                    ${c.detalle ? `${c.detalle}<br>` : ""}
                    ${fecha}
                    Estado: <strong>${c.estado || "-"}</strong>
                  </div>
                </div>
              </div>
            </div>
          `;
        }).join("");
        listaCompromisos.innerHTML = html;
      }

      // 2. Historial de observaciones
      const observaciones = j.historialObservaciones || [];
      if (!observaciones.length) {
        historialObservaciones.innerHTML = `
          <div class="alert alert-secondary mb-0">
            No hay observaciones registradas para este proyecto.
          </div>`;
      } else {
        const htmlObs = observaciones.map(obs => {
          const estadoBadge   = getEstadoBadge(obs.estado);
          const fechaCreacion = obs.fecha_creacion ? formatearFecha(obs.fecha_creacion) : '-';
          const fechaRespuesta = obs.fecha_respuesta ? formatearFecha(obs.fecha_respuesta) : '-';

          return `
            <div class="card mb-3 shadow-sm">
              <div class="card-header d-flex justify-content-between align-items-center">
                <span><strong>Observaci√≥n del Consejo</strong></span>
                ${estadoBadge}
              </div>
              <div class="card-body">
                <p class="mb-2"><strong>üìã Descripci√≥n de la observaci√≥n</strong></p>
                <p class="text-muted mb-3" style="white-space: pre-line;">${escapeHtml(obs.texto)}</p>

                ${obs.respuesta ? `
                  <hr>
                  <p class="mb-2"><strong>üí¨ Respuesta de la ONG:</strong></p>
                  <p class="text-muted mb-2" style="white-space: pre-line;">${escapeHtml(obs.respuesta)}</p>
                  <small class="text-muted">Respondida el: ${fechaRespuesta}</small>
                ` : ""}

                <div class="mt-2 text-end small text-muted">
                  Creada el: ${fechaCreacion}
                </div>
              </div>
            </div>
          `;
        }).join("");
        historialObservaciones.innerHTML = htmlObs;
      }

      // 3. L√≥gica de observaciones pendientes / bloqueo
      const tieneObservacionesProblematicas = j.historialObservaciones && j.historialObservaciones.some(
        obs => obs.estado === 'pendiente' || obs.estado === 'rechazada' || obs.estado === 'respondida'
      );

      if (j.observacionPendiente && rol !== "red_ongs") {
        const obs = j.observacionPendiente;
        let tituloAlert = "‚ö†Ô∏è Ten√©s una observaci√≥n pendiente del Consejo";
        let claseAlert = "alert-danger";

        if (obs.estado === 'rechazada') {
          tituloAlert = "‚ùå Tu respuesta anterior fue RECHAZADA";
        }

        const fechaCreacion = obs.fecha_creacion ? formatearFecha(obs.fecha_creacion) : "";

        let bloqueBoton = `
          <div class="text-end">
            <button class="btn btn-danger fw-bold" onclick="abrirModalResponder(${obs.id}, '${escapeHtml(obs.texto)}')">
              Responder observaci√≥n
            </button>
          </div>`;

        if (btnFinalizarProyecto) btnFinalizarProyecto.disabled = true;
        btnVolverProyecto.classList.add("disabled");

        setMsg(`
          <div class="alert ${claseAlert} border border-danger shadow-sm">
            <h4>${tituloAlert}</h4>
            <p>El Consejo Directivo realiz√≥ observaciones sobre la ejecuci√≥n del proyecto. Ten√©s que responder para poder continuar.</p>
            ${fechaCreacion ? `<p class="mb-1"><small class="text-muted">Creada el ${fechaCreacion}</small></p>` : ""}
            <hr>
            <p><strong>Detalle:</strong> "${escapeHtml(obs.texto)}"</p>
            ${bloqueBoton}
          </div>
        `);
      } else if (tieneObservacionesProblematicas && rol !== "red_ongs") {
        setMsg(`
          <div class="alert alert-warning border border-warning shadow-sm">
            <h4>‚è≥ Observaciones en proceso</h4>
            <p>Hay observaciones que est√°n siendo evaluadas por el Consejo Directivo. No pod√©s finalizar el proyecto hasta que todas est√©n resueltas.</p>
          </div>
        `);
        if (btnFinalizarProyecto) btnFinalizarProyecto.disabled = true;
      } else {
        setMsg("");
        if (btnFinalizarProyecto && rol !== "red_ongs") btnFinalizarProyecto.disabled = false;
        btnVolverProyecto.classList.remove("disabled");
      }

    } catch (e) {
      console.error(e);
      setMsg('<div class="alert alert-danger">Error de red al cargar el resumen.</div>');
    }
  }

  function getEstadoBadge(estado) {
    const badges = {
      'pendiente': '<span class="badge bg-warning text-dark">‚è≥ Pendiente de respuesta</span>',
      'respondida': '<span class="badge bg-info text-dark">üí¨ Respondida - En evaluaci√≥n</span>',
      'aprobada': '<span class="badge bg-success">‚úÖ Aprobada</span>',
      'rechazada': '<span class="badge bg-danger">‚ùå Rechazada</span>',
      'vencida': '<span class="badge bg-secondary">‚è∞ Vencida</span>'
    };
    return badges[estado] || `<span class="badge bg-secondary">${estado}</span>`;
  }

  function abrirModalResponder(id, texto) {
    document.getElementById("idObservacionResponder").value = id;
    document.getElementById("textoObservacionModal").innerText = texto;
    document.getElementById("textoRespuesta").value = "";
    modalResponder.show();
  }

  async function enviarRespuesta() {
    const caseId = qp("case");
    const obsId  = document.getElementById("idObservacionResponder").value;
    const resp   = document.getElementById("textoRespuesta").value.trim();

    if (!resp) {
      alert("Por favor, escrib√≠ una respuesta.");
      return;
    }

    const btn = document.querySelector('#modalResponder .btn-danger');
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = "Enviando...";

    try {
      const res = await fetch("/api/bonita/responder-observacion/", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
          caseId: caseId,
          observacionId: parseInt(obsId),
          respuesta: resp
        })
      });

      const j = await res.json();

      if (j.ok) {
        alert("Respuesta enviada correctamente. El Consejo Directivo la evaluar√°.");
        modalResponder.hide();
        location.reload();
      } else {
        alert("Error al enviar respuesta: " + (j.error || "Desconocido"));
      }
    } catch (err) {
      alert("Error de red al enviar la respuesta.");
    } finally {
      btn.disabled = false;
      btn.innerHTML = originalText;
    }
  }

  async function finalizarProyecto() {
    const caseId     = qp("case");
    const proyectoId = qp("proyecto");

    if (!caseId || !proyectoId) {
      alert("Faltan par√°metros necesarios para finalizar el proyecto.");
      return;
    }

    const confirmar = confirm(
      "¬øEst√°s seguro de que quer√©s finalizar este proyecto?\n\n" +
      "Esta acci√≥n cambia el estado del proyecto a 'Finalizado' y no se puede deshacer."
    );
    if (!confirmar) return;

    const btn = document.getElementById("btnFinalizarProyecto");
    const textoOriginal = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Finalizando...';

    try {
      const res = await fetch("/api/bonita/finalizar-proyecto/", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          caseId: caseId,
          proyectoId: parseInt(proyectoId)
        })
      });

      const j = await res.json();

      if (j.ok) {
        setMsg(`
          <div class="alert alert-success">
            <strong>‚úì Proyecto finalizado correctamente</strong>
            <p class="mb-0">El proyecto fue marcado como finalizado. Redirigiendo...</p>
          </div>
        `);

        setTimeout(() => {
          window.location.href = '/bonita/login/';
        }, 2000);
      } else {
        alert("Error al finalizar proyecto: " + (j.error || "Desconocido"));
        btn.disabled = false;
        btn.innerHTML = textoOriginal;
      }
    } catch (err) {
      alert("Error de red al finalizar el proyecto.");
      btn.disabled = false;
      btn.innerHTML = textoOriginal;
    }
  }

  function escapeHtml(text) {
    if (!text) return text;
    return text
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }
</script>

</body>
</html>
