<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Revisar proyectos</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
  <div class="container">
    <a class="navbar-brand" href="/bonita/login/">ProjectPlanning</a>
  </div>
</nav>

<div class="container py-4" style="max-width:900px">
  <div class="card shadow-sm">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
      <h4 class="mb-0">Revisar proyectos</h4>
      <button id="btnCargar" class="btn btn-light btn-sm">Cargar desde Bonita</button>
    </div>
    <div class="card-body">
      <div class="alert alert-info">
        Caso: <code id="caseOut">{{ request.GET.case }}</code>
      </div>
      <div id="panel"></div>
      <div id="msg" class="mt-3"></div>
    </div>
  </div>
</div>

<script>
  function qp(n){ return new URLSearchParams(location.search).get(n); }

  // üîê Solo Red de ONGs puede revisar proyectos
  (function () {
    const rol = qp("rol");
    if (rol && rol !== "red_ongs") {
      document.body.innerHTML =
        '<div class="container py-5"><div class="alert alert-warning">No ten√©s permiso para revisar proyectos.</div></div>';
      throw new Error("No autorizado");
    }
  })();

  async function cargar() {
    const caseId = qp("case");
    if (!caseId) {
      document.getElementById("panel").innerHTML =
        `<div class="alert alert-warning">No se recibi√≥ <b>case</b> en la URL.</div>`;
      return;
    }
    const res = await fetch(`/api/bonita/revisar/?case=${encodeURIComponent(caseId)}`);
    const j = await res.json();
    if (!res.ok || !j.ok) {
      document.getElementById("panel").innerHTML =
        `<div class="alert alert-danger">Error: ${j.error || res.status}</div>`;
      return;
    }
    const arr = j.proyectos || [];
    if (arr.length === 0) {
      document.getElementById("panel").innerHTML =
        `<div class="alert alert-secondary">No hay proyectos disponibles.</div>`;
      return;
    }
    const html = arr.map(p => `
      <div class="border rounded p-3 mb-2">
        <div class="d-flex justify-content-between">
          <div>
            <h5 class="mb-1">${p.nombre || 'Proyecto'}</h5>
            <div class="text-muted small">ID: ${p.id ?? '-'}</div>
          </div>
          <button class="btn btn-sm btn-outline-primary"
                  onclick="colaborar(${p.id})">
            Ver pedidos
          </button>
        </div>
        ${p.descripcion ? `<p class="mt-2 mb-0">${p.descripcion}</p>` : ""}
      </div>
    `).join("");
    document.getElementById("panel").innerHTML = html;
  }

  async function colaborar(proyectoId) {
    const caseId = qp("case");
    const rol = qp("rol") || "";
    if (!caseId) {
      document.getElementById("msg").innerHTML =
        `<div class="alert alert-warning">No se encontr√≥ caseId en la URL.</div>`;
      return;
    }
    document.getElementById("msg").innerHTML = "";

    const res = await fetch("/api/bonita/elegir-proyecto/", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({ caseId, proyectoId })
    });

    const j = await res.json();
    if (!res.ok || !j.ok) {
      document.getElementById("msg").innerHTML =
        `<div class="alert alert-danger">Error al seleccionar proyecto: ${j.error || res.status}</div>`;
      return;
    }

    const url =
      `/bonita/ver-pedidos/?case=${encodeURIComponent(caseId)}&proyecto=${encodeURIComponent(proyectoId)}&rol=${encodeURIComponent(rol)}`;
    location.href = url;
  }

  document.getElementById("btnCargar").addEventListener("click", cargar);
  cargar();

  window.colaborar = colaborar;
</script>
</body>
</html>
